<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.5.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Ye Zhaoliang">

  
  
  
    
  
  <meta name="description" content="">

  
  <link rel="alternate" hreflang="en-us" href="https://jueqingsizhe66.github.io/blog/2014/05/14/poisson/">

  


  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/solarized-dark.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/solarized-dark.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="anonymous">
    

    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.e8d4d5fd376e67b34452ebe1cae16341.css">

  

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon-32.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://jueqingsizhe66.github.io/blog/2014/05/14/poisson/">

  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@jueqingsizhe66">
  <meta property="twitter:creator" content="@jueqingsizhe66">
  
  <meta property="og:site_name" content="简约派">
  <meta property="og:url" content="https://jueqingsizhe66.github.io/blog/2014/05/14/poisson/">
  <meta property="og:title" content="poisson | 简约派">
  <meta property="og:description" content=""><meta property="og:image" content="https://jueqingsizhe66.github.io/img/icon-192.png">
  <meta property="twitter:image" content="https://jueqingsizhe66.github.io/img/icon-192.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2014-05-14T02:09:00&#43;08:00">
    
    <meta property="article:modified_time" content="2014-05-14T02:09:00&#43;08:00">
  

  



  


  


  





  <title>poisson | 简约派</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">简约派</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#hero"><span>概要</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>博文</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>项目</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#featured"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/about/"><span>About</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/courses/"><span>课程</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/categories/"><span>分类</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/archives"><span>归档</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#tags"><span>标签</span></a>
        </li>

        
        

      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


  <article class="article">

  








  
 <script async src="//cdn.busuanzi.ibruce.info/cdn/busuanzi/2.3/busuanzi.pure.mini.js"></script> 
 <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> 
 <script> 
     $(document).ready(function() { 
         var int = setInterval(fixCount, 100); 
         var busuanziSiteOffset =  100000  
         function fixCount() { 
             if ($("#busuanzi_container_site_pv").css("display") != "none") { 
                 clearInterval(int); 
                 $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + busuanziSiteOffset); 
             } 
         } 
     }); 
 </script> 
  






  

  
  
  
<div class="article-container pt-3">
  <h1>poisson</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    May 14, 2014
  </span>

  

  

  

  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="">物理</a>, <a href="">方法</a></span>

  
</div>

    














  
</div>





<span class="article-metadata" >Reading time: 28 minutes and    12 seconds with 6205 words. 本文总阅读量<span id="busuanzi_value_page_pv"></span>次 </span>
    <aside>
        <nav id="TableOfContents"></nav>
    </aside>
  <div class="article-container">


    <div class="article-style">
      <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fortran" data-lang="fortran">
<span style="color:#66d9ef">module </span>decomp_2d_poisson

  <span style="color:#66d9ef">use </span>decomp_2d
  <span style="color:#66d9ef">use </span>decomp_2d_fft

  <span style="color:#66d9ef">use </span>param
  <span style="color:#66d9ef">use </span>variables

  <span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">  </span><span style="color:#66d9ef">private</span>        <span style="color:#75715e">! Make everything private unless declared public
</span><span style="color:#75715e"></span>
<span style="color:#75715e">!  real(mytype), private, parameter :: PI = 3.14159265358979323846_mytype
</span><span style="color:#75715e"></span><span style="color:#75715e">!                                   This 0.0_mytype!!!!!!!!!!!!!1111
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#ifdef DOUBLE_PREC
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">parameter</span> <span style="color:#66d9ef">::</span> epsilon <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.e-16</span>
<span style="color:#75715e">#else
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">parameter</span> <span style="color:#66d9ef">::</span> epsilon <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.e-8</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">! boundary conditions
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">integer</span>, <span style="color:#66d9ef">save</span> <span style="color:#66d9ef">::</span> bcx, bcy, bcz

  <span style="color:#75715e">! decomposition object for physical space
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">TYPE</span>(DECOMP_INFO), <span style="color:#66d9ef">save</span> <span style="color:#66d9ef">::</span> ph
 
  <span style="color:#75715e">! decomposition object for spectral space
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">TYPE</span>(DECOMP_INFO), <span style="color:#66d9ef">save</span> <span style="color:#66d9ef">::</span> sp

  <span style="color:#75715e">! store sine/cosine factors
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">save</span>, <span style="color:#66d9ef">allocatable</span>, <span style="color:#66d9ef">dimension</span>(:) <span style="color:#66d9ef">::</span> az,bz
  <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">save</span>, <span style="color:#66d9ef">allocatable</span>, <span style="color:#66d9ef">dimension</span>(:) <span style="color:#66d9ef">::</span> ay,by
  <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">save</span>, <span style="color:#66d9ef">allocatable</span>, <span style="color:#66d9ef">dimension</span>(:) <span style="color:#66d9ef">::</span> ax,bx

  <span style="color:#75715e">! wave numbers
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">complex</span>(mytype), <span style="color:#66d9ef">save</span>, <span style="color:#66d9ef">allocatable</span>, <span style="color:#66d9ef">dimension</span>(:,:,:) <span style="color:#66d9ef">::</span> kxyz
  <span style="color:#75715e">!wave numbers for stretching in a pentadiagonal matrice
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">complex</span>(mytype), <span style="color:#66d9ef">save</span>, <span style="color:#66d9ef">allocatable</span>, <span style="color:#66d9ef">dimension</span>(:,:,:,:) <span style="color:#66d9ef">::</span> a,a2,a3
  <span style="color:#75715e">! work arrays,
</span><span style="color:#75715e"></span>  <span style="color:#75715e">! naming convention: cw (complex); rw (real);
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!                    1 = X-pencil; 2 = Y-pencil; 3 = Z-pencil
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">allocatable</span>, <span style="color:#66d9ef">dimension</span>(:,:,:) <span style="color:#66d9ef">::</span> rw1,rw1b,rw2,rw2b,rw3
  <span style="color:#66d9ef">complex</span>(mytype), <span style="color:#66d9ef">allocatable</span>, <span style="color:#66d9ef">dimension</span>(:,:,:) <span style="color:#66d9ef">::</span> cw1,cw1b,cw2,cw22,cw2b,cw2c

  <span style="color:#75715e">! underlying FFT library only needs to be initialised once
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">logical</span>, <span style="color:#66d9ef">save</span> <span style="color:#66d9ef">::</span> fft_initialised <span style="color:#f92672">=</span> .false.

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">::</span> decomp_2d_poisson_stg, decomp_2d_poisson_init, &amp;
       decomp_2d_poisson_finalize

  <span style="color:#75715e">! For staggered mesh where main variables are defined in the centre of
</span><span style="color:#75715e"></span>  <span style="color:#75715e">! control volumes while boundary conditions are defined on interfaces
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">interface </span>decomp_2d_poisson_stg
     <span style="color:#66d9ef">module </span><span style="color:#66d9ef">procedure </span>poisson
  <span style="color:#66d9ef">end </span><span style="color:#66d9ef">interface
</span><span style="color:#66d9ef"></span><span style="color:#66d9ef">contains</span>



  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">! Initialise Poisson solver for given boundary conditions
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!                               given
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!                               given
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!   just for init
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">subroutine </span>decomp_2d_poisson_init(bcx1, bcy1, bcz1)

    <span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">integer</span>, <span style="color:#66d9ef">intent</span>(IN) <span style="color:#66d9ef">::</span> bcx1, bcy1, bcz1
    <span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">::</span> nx, ny, nz, i

    bcx <span style="color:#f92672">=</span> bcx1
    bcy <span style="color:#f92672">=</span> bcy1
    bcz <span style="color:#f92672">=</span> bcz1

    nx <span style="color:#f92672">=</span> nx_global
    ny <span style="color:#f92672">=</span> ny_global
    nz <span style="color:#f92672">=</span> nz_global

    <span style="color:#75715e">! pressure-grid having 1 fewer point for non-periodic directions
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) nx<span style="color:#f92672">=</span>nx<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">if</span> (bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) ny<span style="color:#f92672">=</span>ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">if</span> (bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) nz<span style="color:#f92672">=</span>nz<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

    <span style="color:#66d9ef">allocate</span>(ax(nx),bx(nx))
    <span style="color:#66d9ef">allocate</span>(ay(ny),by(ny))
    <span style="color:#66d9ef">allocate</span>(az(nz),bz(nz))
    <span style="color:#66d9ef">call </span>abxyz(ax,ay,az,bx,by,bz,nx,ny,nz,bcx,bcy,bcz)
    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Initialise the ax bx
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Initialise the ay by
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Initialise the az bz
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1
</span><span style="color:#75715e"></span>

    <span style="color:#66d9ef">call </span>decomp_info_init(nx, ny, nz, ph)
    <span style="color:#66d9ef">call </span>decomp_info_init(nx, ny, nz<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, sp)

    <span style="color:#75715e">! allocate work space
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">allocate</span>(cw1(sp%xst(<span style="color:#ae81ff">1</span>):sp%xen(<span style="color:#ae81ff">1</span>),sp%xst(<span style="color:#ae81ff">2</span>):sp%xen(<span style="color:#ae81ff">2</span>), &amp;
            sp%xst(<span style="color:#ae81ff">3</span>):sp%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(kxyz(sp%xst(<span style="color:#ae81ff">1</span>):sp%xen(<span style="color:#ae81ff">1</span>),sp%xst(<span style="color:#ae81ff">2</span>):sp%xen(<span style="color:#ae81ff">2</span>), &amp;
            sp%xst(<span style="color:#ae81ff">3</span>):sp%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(a(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#66d9ef">allocate</span>(a2(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#66d9ef">allocate</span>(a3(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#75715e">! (000)  ^c  ^kxyz ^a
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">allocate</span>(cw1(sp%xst(<span style="color:#ae81ff">1</span>):sp%xen(<span style="color:#ae81ff">1</span>),sp%xst(<span style="color:#ae81ff">2</span>):sp%xen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%xst(<span style="color:#ae81ff">3</span>):sp%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw1b(sp%xst(<span style="color:#ae81ff">1</span>):sp%xen(<span style="color:#ae81ff">1</span>),sp%xst(<span style="color:#ae81ff">2</span>):sp%xen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%xst(<span style="color:#ae81ff">3</span>):sp%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(rw1(ph%xst(<span style="color:#ae81ff">1</span>):ph%xen(<span style="color:#ae81ff">1</span>),ph%xst(<span style="color:#ae81ff">2</span>):ph%xen(<span style="color:#ae81ff">2</span>), &amp;
            ph%xst(<span style="color:#ae81ff">3</span>):ph%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(rw1b(ph%xst(<span style="color:#ae81ff">1</span>):ph%xen(<span style="color:#ae81ff">1</span>),ph%xst(<span style="color:#ae81ff">2</span>):ph%xen(<span style="color:#ae81ff">2</span>), &amp;
            ph%xst(<span style="color:#ae81ff">3</span>):ph%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(rw2(ph%yst(<span style="color:#ae81ff">1</span>):ph%yen(<span style="color:#ae81ff">1</span>),ph%yst(<span style="color:#ae81ff">2</span>):ph%yen(<span style="color:#ae81ff">2</span>), &amp;
            ph%yst(<span style="color:#ae81ff">3</span>):ph%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(kxyz(sp%xst(<span style="color:#ae81ff">1</span>):sp%xen(<span style="color:#ae81ff">1</span>),sp%xst(<span style="color:#ae81ff">2</span>):sp%xen(<span style="color:#ae81ff">2</span>), &amp;
            sp%xst(<span style="color:#ae81ff">3</span>):sp%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(a(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#66d9ef">allocate</span>(a2(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#66d9ef">allocate</span>(a3(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#75715e">!(100)      consist :: cw1 cw1b   rw1   rw1b   rw2    ^a
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span> .and. bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">allocate</span>(rw2(ph%yst(<span style="color:#ae81ff">1</span>):ph%yen(<span style="color:#ae81ff">1</span>),ph%yst(<span style="color:#ae81ff">2</span>):ph%yen(<span style="color:#ae81ff">2</span>), &amp;
            ph%yst(<span style="color:#ae81ff">3</span>):ph%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(rw2b(ph%yst(<span style="color:#ae81ff">1</span>):ph%yen(<span style="color:#ae81ff">1</span>),ph%yst(<span style="color:#ae81ff">2</span>):ph%yen(<span style="color:#ae81ff">2</span>), &amp;
            ph%yst(<span style="color:#ae81ff">3</span>):ph%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw1(sp%xst(<span style="color:#ae81ff">1</span>):sp%xen(<span style="color:#ae81ff">1</span>),sp%xst(<span style="color:#ae81ff">2</span>):sp%xen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%xst(<span style="color:#ae81ff">3</span>):sp%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw2(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw22(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>), &amp;
            sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw2b(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw2c(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(kxyz(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>), &amp;
            sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(a(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#66d9ef">allocate</span>(a2(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#66d9ef">allocate</span>(a3(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#75715e">!(010)  rw2 rw2b cw2 cw22 cw2b cw2c kxyz  ^a
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">allocate</span>(cw1(sp%xst(<span style="color:#ae81ff">1</span>):sp%xen(<span style="color:#ae81ff">1</span>),sp%xst(<span style="color:#ae81ff">2</span>):sp%xen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%xst(<span style="color:#ae81ff">3</span>):sp%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw1b(sp%xst(<span style="color:#ae81ff">1</span>):sp%xen(<span style="color:#ae81ff">1</span>),sp%xst(<span style="color:#ae81ff">2</span>):sp%xen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%xst(<span style="color:#ae81ff">3</span>):sp%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw2(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw22(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>), &amp;
            sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw2b(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(cw2c(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>), &amp;
                 sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(rw1(ph%xst(<span style="color:#ae81ff">1</span>):ph%xen(<span style="color:#ae81ff">1</span>),ph%xst(<span style="color:#ae81ff">2</span>):ph%xen(<span style="color:#ae81ff">2</span>), &amp;
            ph%xst(<span style="color:#ae81ff">3</span>):ph%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(rw1b(ph%xst(<span style="color:#ae81ff">1</span>):ph%xen(<span style="color:#ae81ff">1</span>),ph%xst(<span style="color:#ae81ff">2</span>):ph%xen(<span style="color:#ae81ff">2</span>), &amp;
            ph%xst(<span style="color:#ae81ff">3</span>):ph%xen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(rw2(ph%yst(<span style="color:#ae81ff">1</span>):ph%yen(<span style="color:#ae81ff">1</span>),ph%yst(<span style="color:#ae81ff">2</span>):ph%yen(<span style="color:#ae81ff">2</span>), &amp;
            ph%yst(<span style="color:#ae81ff">3</span>):ph%yen(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">allocate</span>(rw2b(ph%yst(<span style="color:#ae81ff">1</span>):ph%yen(<span style="color:#ae81ff">1</span>),ph%yst(<span style="color:#ae81ff">2</span>):ph%yen(<span style="color:#ae81ff">2</span>), &amp;
            ph%yst(<span style="color:#ae81ff">3</span>):ph%yen(<span style="color:#ae81ff">3</span>)))
        <span style="color:#75715e">!(11*) cw1 cw1b cw2 cw2b  cw2c  rw1 rw1b rw2b
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">if</span> (bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then  
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">allocate</span>(rw3(ph%zsz(<span style="color:#ae81ff">1</span>),ph%zsz(<span style="color:#ae81ff">2</span>),ph%zsz(<span style="color:#ae81ff">3</span>)))
       <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">allocate</span>(kxyz(sp%xst(<span style="color:#ae81ff">1</span>):sp%xen(<span style="color:#ae81ff">1</span>),sp%xst(<span style="color:#ae81ff">2</span>):sp%xen(<span style="color:#ae81ff">2</span>), &amp;
            sp%xst(<span style="color:#ae81ff">3</span>):sp%xen(<span style="color:#ae81ff">3</span>)))    
       <span style="color:#66d9ef">allocate</span>(a(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#66d9ef">allocate</span>(a2(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))
       <span style="color:#66d9ef">allocate</span>(a3(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>),nym,sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>),<span style="color:#ae81ff">5</span>))      
       <span style="color:#75715e">!(111) rw3  kxyz  ^a
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">call </span>waves()

    <span style="color:#66d9ef">return
</span><span style="color:#66d9ef">  </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>decomp_2d_poisson_init


  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">! Release memory used by Poisson solver
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">subroutine </span>decomp_2d_poisson_finalize

    <span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">deallocate</span>(ax,bx,ay,by,az,bz)

    <span style="color:#66d9ef">call </span>decomp_info_finalize(ph)
    <span style="color:#66d9ef">call </span>decomp_info_finalize(sp)

    <span style="color:#66d9ef">call </span>decomp_2d_fft_finalize
    fft_initialised <span style="color:#f92672">=</span> .false.

    <span style="color:#66d9ef">deallocate</span>(kxyz)

    <span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">deallocate</span>(cw1)
       <span style="color:#75715e">! (000) cw1
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">deallocate</span>(cw1,cw1b,rw1,rw1b,rw2)
       <span style="color:#75715e">! (100)   cw1 cw1b rw1 rw1b rw2
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span> .and. bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">deallocate</span>(cw1,cw2,cw2b,rw2,rw2b)
       <span style="color:#75715e">! (010)   cw1 cw2  cw2b  rw2 rw2b
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">deallocate</span>(cw1,cw1b,cw2,cw2b,rw1,rw1b,rw2,rw2b)
       <span style="color:#75715e">! (11*)   cw1,cw1b,cw2,cw2b,rw1,rw1b,rw2,rw2b
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">if</span> (bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">deallocate</span>(rw3)
        <span style="color:#75715e">!(111)    rw3
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">return
</span><span style="color:#66d9ef">  </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>decomp_2d_poisson_finalize


  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">! Top level wrapper
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">subroutine </span>poisson(rhs, bcx, bcy, bcz)

    <span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">dimension</span>(:,:,:), <span style="color:#66d9ef">intent</span>(INOUT) <span style="color:#66d9ef">::</span> rhs
    <span style="color:#66d9ef">integer</span>, <span style="color:#66d9ef">intent</span>(IN) <span style="color:#66d9ef">::</span> bcx, bcy, bcz  <span style="color:#75715e">! boundary conditions
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">::</span> i

    <span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>poisson_000(rhs)
    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>poisson_100(rhs)
    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span> .and. bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>poisson_010(rhs)
    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span> .and. bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then</span>   <span style="color:#75715e">! 110 &amp; 111
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">call </span>poisson_11x(rhs, bcz)
    <span style="color:#66d9ef">else
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">stop</span> <span style="color:#e6db74">&#39;boundary condition not supported&#39;</span>
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">return
</span><span style="color:#66d9ef">  </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>poisson


  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">! Solving 3D Poisson equation with periodic B.C in all 3 dimensions
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!                                                      3
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!                                                      3
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">subroutine </span>poisson_000(rhs)

    <span style="color:#66d9ef">use </span>derivX
    <span style="color:#66d9ef">use </span>derivY
    <span style="color:#66d9ef">use </span>derivZ

    <span style="color:#75715e">! right-hand-side of Poisson as input
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! solution of Poisson as output
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">dimension</span>(:,:,:), <span style="color:#66d9ef">intent</span>(INOUT) <span style="color:#66d9ef">::</span> rhs

    <span style="color:#66d9ef">integer</span>, <span style="color:#66d9ef">dimension</span>(<span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">::</span> fft_start, fft_end, fft_size

    <span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> xyzk

    <span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> ytt,xtt,ztt,yt1,xt1,yt2,xt2
    <span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> xtt1,ytt1,ztt1,zt1,zt2


    <span style="color:#66d9ef">real</span>(mytype) <span style="color:#66d9ef">::</span> tmp1, tmp2,x ,y, z
    
    <span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">::</span> nx,ny,nz, i,j,k

    nx <span style="color:#f92672">=</span> nx_global
    ny <span style="color:#f92672">=</span> ny_global
    nz <span style="color:#f92672">=</span> nz_global

    <span style="color:#66d9ef">if</span> (.not. fft_initialised) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>decomp_2d_fft_init(PHYSICAL_IN_Z)
       fft_initialised <span style="color:#f92672">=</span> .true.
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if</span>

    <span style="color:#75715e">! compute r2c transform   r2c:real to complex by zhaoliang
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! cw1 is 3dim data structrue
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!! only fft to transform the real data to complex data while (100) twice
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!! one is tranform and then fft  (you can see poisson100
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>decomp_2d_fft_3d(rhs,cw1)
    

    <span style="color:#75715e">! normalisation
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!  why this below is called normalisation ??????  just divide 3dim grid number
</span><span style="color:#75715e"></span>    cw1 <span style="color:#f92672">=</span> cw1 <span style="color:#f92672">/</span> <span style="color:#66d9ef">real</span>(nx, kind<span style="color:#f92672">=</span>mytype) <span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(ny, kind<span style="color:#f92672">=</span>mytype) &amp;
         <span style="color:#f92672">/</span> <span style="color:#66d9ef">real</span>(nz, kind<span style="color:#f92672">=</span>mytype)

    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)

             <span style="color:#75715e">! post-processing in spectral space
</span><span style="color:#75715e"></span>
             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!post-processing in 3-direction can be
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!! set in the same cycle,because they are
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!! similar
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
             <span style="color:#75715e">! POST PROCESSING IN Z
</span><span style="color:#75715e"></span>             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)   <span style="color:#75715e">!  get the real number of cw1
</span><span style="color:#75715e"></span>             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))               <span style="color:#75715e">!  get the imagenumber of cw1
</span><span style="color:#75715e"></span>             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>az(k), &amp;
                  tmp2<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>az(k), kind<span style="color:#f92672">=</span>mytype)   <span style="color:#75715e">! modify the cw1 in the spectral space Z
</span><span style="color:#75715e"></span>                                                    <span style="color:#75715e">!  bz  az
</span><span style="color:#75715e"></span>                                                    <span style="color:#75715e">!  by  ay
</span><span style="color:#75715e"></span>                                                    <span style="color:#75715e">!  bx  ax
</span><span style="color:#75715e"></span>
             <span style="color:#75715e">! POST PROCESSING IN Y
</span><span style="color:#75715e"></span>             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>ay(j), &amp;
                  tmp2<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>ay(j), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">if</span> (j.gt.(ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) cw1(i,j,k)<span style="color:#f92672">=</span><span style="color:#f92672">-</span>cw1(i,j,k)   <span style="color:#75715e">! why should be axisymmetry!
</span><span style="color:#75715e"></span>
             <span style="color:#75715e">! POST PROCESSING IN X
</span><span style="color:#75715e"></span>             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>ax(i), &amp;
                  tmp2<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>ax(i), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">if</span> (i.gt.(nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) cw1(i,j,k)<span style="color:#f92672">=</span><span style="color:#f92672">-</span>cw1(i,j,k)

             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!! Solve Poisson
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
             tmp1<span style="color:#f92672">=</span><span style="color:#66d9ef">real</span>(kxyz(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2<span style="color:#f92672">=</span>aimag(kxyz(i,j,k))
             <span style="color:#75715e">! CANNOT DO A DIVISION BY ZERO
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!  Yes ! division  by zero is impossible!!!-----------------------------------&lt;
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> ((tmp1.lt.epsilon).or.(tmp2.lt.epsilon)) <span style="color:#66d9ef">then</span>   <span style="color:#75715e">!epsilon?  what does it mean?
</span><span style="color:#75715e"></span>                cw1(i,j,k)<span style="color:#f92672">=</span><span style="color:#ae81ff">0._mytype</span>
<span style="color:#75715e">!                print *,&#39;DIV 0&#39;,i,j,k,epsilon
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">else
</span><span style="color:#66d9ef">                </span>cw1(i,j,k)<span style="color:#f92672">=</span>cmplx( <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype) <span style="color:#f92672">/</span> (<span style="color:#f92672">-</span>tmp1), &amp;
                     aimag(cw1(i,j,k))<span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp2), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if</span>

           <span style="color:#75715e">!Print result in spectal space after Poisson
</span><span style="color:#75715e"></span>      <span style="color:#75715e">!     if (abs(out(i,j,k)) &gt; 1.0e-4) then
</span><span style="color:#75715e"></span>      <span style="color:#75715e">!        write(*,*) &#39;AFTER&#39;,i,j,k,out(i,j,k),xyzk
</span><span style="color:#75715e"></span>      <span style="color:#75715e">!     end if
</span><span style="color:#75715e"></span>

             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">! post-processing backward
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             
             <span style="color:#75715e">! POST PROCESSING IN Z
</span><span style="color:#75715e"></span>             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">-</span>tmp2<span style="color:#f92672">*</span>az(k), &amp;
                  <span style="color:#f92672">-</span>tmp2<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>az(k), kind<span style="color:#f92672">=</span>mytype)
              <span style="color:#75715e">!                                          bz    az
</span><span style="color:#75715e"></span>              <span style="color:#75715e">!                                          by    ay
</span><span style="color:#75715e"></span>              <span style="color:#75715e">!                                          bx    ax
</span><span style="color:#75715e"></span>
             <span style="color:#75715e">! POST PROCESSING IN Y
</span><span style="color:#75715e"></span>             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>ay(j), &amp;
                  tmp2<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>ay(j), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">if</span> (j.gt.(ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) cw1(i,j,k)<span style="color:#f92672">=</span><span style="color:#f92672">-</span>cw1(i,j,k)

             <span style="color:#75715e">! POST PROCESSING IN X
</span><span style="color:#75715e"></span>             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>ax(i), &amp;
                  <span style="color:#f92672">-</span>tmp2<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">+</span>tmp1<span style="color:#f92672">*</span>ax(i), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">if</span> (i.gt.(nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) cw1(i,j,k)<span style="color:#f92672">=</span><span style="color:#f92672">-</span>cw1(i,j,k)

          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
             
    <span style="color:#75715e">! compute c2r transform
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>decomp_2d_fft_3d(cw1,rhs)    <span style="color:#75715e">!  from complex  to real!
</span><span style="color:#75715e"></span>    
 <span style="color:#75715e">!   call decomp_2d_fft_finalize
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return
</span><span style="color:#66d9ef">  </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>poisson_000


  <span style="color:#66d9ef">subroutine </span>poisson_100(rhs)
      <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>      <span style="color:#75715e">!!!! get the rhs and then modify rhs ,at last return the rhs
</span><span style="color:#75715e"></span>      <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>

    <span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">dimension</span>(:,:,:), <span style="color:#66d9ef">intent</span>(INOUT) <span style="color:#66d9ef">::</span> rhs

    <span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> xyzk
    <span style="color:#66d9ef">real</span>(mytype) <span style="color:#66d9ef">::</span> tmp1, tmp2, tmp3, tmp4
    <span style="color:#66d9ef">real</span>(mytype) <span style="color:#66d9ef">::</span> xx1,xx2,xx3,xx4,xx5,xx6,xx7,xx8
    
    <span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">::</span> nx,ny,nz, i,j,k, itmp
    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!  8 transform   from x --&gt;y --&gt;z then z--&gt; y ---&gt;x at the beginning
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!from x --&gt;y --&gt;z then z--&gt; y ---&gt;x at the endding
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!  (100 add 8 more transform than 000) while 000 is 0 transform
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!  so rhs is in the z pencil ,no there are not z pencil at all!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!   the program is  2-dim pm*pn decomp !  so only  xpencil and y pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
                   <span style="color:#75715e">!!!!!!!!!!!!!!twice real to complex
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 1: transform rhs-rw2-rw1
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 2: fft       rhs-----rw1
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!!!twice complex to real
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 1: transfrom rw1-rw2--rhs
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 2: fft       rw1------rhs
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!! post-processing operations is under the complex condition
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   input real rhs(:.:,:) in the z pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   2+2 transform    |destination: modify the rhs
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 normalisation
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 FFT forward
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   3 post-processing   z--&gt;y---&gt;x  direction not pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 poisson solver
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   3 post-processing backward  x---&gt;y----&gt;z  direction
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 FFT backward
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   2+2 transform    |destination: modify the rhs
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   output real rhs(:,:,:)  in the z pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
<span style="color:#ae81ff">100</span> <span style="color:#66d9ef">format</span>(<span style="color:#ae81ff">1</span>x,a8,<span style="color:#ae81ff">3</span>I4,<span style="color:#ae81ff">2</span>F12.<span style="color:#ae81ff">6</span>)

    nx <span style="color:#f92672">=</span> nx_global <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
    ny <span style="color:#f92672">=</span> ny_global
    nz <span style="color:#f92672">=</span> nz_global

    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! rhs is in Z-pencil(wrong!There isn&#39;t Z pencil)(wrong
</span><span style="color:#75715e"></span>      <span style="color:#75715e">!again, there is Z pencil))but requires global operations in X
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! why should do the transpose!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>       <span style="color:#75715e">! why in the poisson_000 is not needed!???????????????
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!   two steps to change from z to x
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">call </span>transpose_z_to_y(rhs,rw2,ph)  <span style="color:#75715e">! z pencil in y pencil but in the physical space
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!rw2 is the complex 3-dim data the same as rw1
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_y_to_x(rw2,rw1,ph)
    <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>ph%xst(<span style="color:#ae81ff">3</span>),ph%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span>ph%xst(<span style="color:#ae81ff">2</span>),ph%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
              <span style="color:#75715e">!!! rw1  rw1b   1 means  x pencil   
</span><span style="color:#75715e"></span>              <span style="color:#75715e">!!! rw2  rw2b   2 means  y pencil
</span><span style="color:#75715e"></span>             rw1b(i,j,k)<span style="color:#f92672">=</span>rw1(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>(i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,j,k)  <span style="color:#75715e">! the odd terms  is for the half before
</span><span style="color:#75715e"></span>          enddo
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,nx
             rw1b(i,j,k)<span style="color:#f92672">=</span>rw1(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>nx<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k)  <span style="color:#75715e">! the reverse terms is for the half after
</span><span style="color:#75715e"></span>          enddo
       enddo
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!3 layers data
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!! rw1b is the top lay data  xpencil     physical space
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!! rw2  is in the middle lay data   y pencil   physical space
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!! rw1 rhs  is in the outer lay data    z pencil  spectral space
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">call </span>transpose_x_to_y(rw1b,rw2,ph)    <span style="color:#75715e">! let x pencil rw1b to y pencil
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_y_to_z(rw2,rhs,ph)     <span style="color:#75715e">! let y pencil rw2 to  z pencil&#39;s rhs
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!first time get what we want
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (.not. fft_initialised) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>decomp_2d_fft_init(PHYSICAL_IN_Z,nx,ny,nz)
       fft_initialised <span style="color:#f92672">=</span> .true.
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if</span>

    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! compute r2c transform
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!           why should force the before pre-posting   ------------------------------&lt;&lt;&lt;&lt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!the most key operation :::: the fft operator: decomp_2d_fft_3d
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">call </span>decomp_2d_fft_3d(rhs,cw1)  <span style="color:#75715e">!  from real to complex!  and begin poission solver
</span><span style="color:#75715e"></span>
    
    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! in the z pencil we did the fft transform
</span><span style="color:#75715e"></span>        <span style="color:#75715e">!!!!!!!!!!!!!!!!!! so cw1 is 3d complex data ,yeah (:,:,:)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>


    <span style="color:#75715e">! normalisation
</span><span style="color:#75715e"></span>    cw1 <span style="color:#f92672">=</span> cw1 <span style="color:#f92672">/</span> <span style="color:#66d9ef">real</span>(nx, kind<span style="color:#f92672">=</span>mytype) <span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(ny, kind<span style="color:#f92672">=</span>mytype) &amp;
         <span style="color:#f92672">/</span> <span style="color:#66d9ef">real</span>(nz, kind<span style="color:#f92672">=</span>mytype)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;START&#39;</span>,i,j,k,cw1(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! post-processing in spectral space
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! POST PROCESSING IN Z
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>az(k), &amp;
                  tmp2<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>az(k), kind<span style="color:#f92672">=</span>mytype)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;after z&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">! POST PROCESSING IN Y
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>ay(j), &amp;
                  tmp2<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>ay(j), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">if</span> (j.gt.(ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) cw1(i,j,k)<span style="color:#f92672">=</span><span style="color:#f92672">-</span>cw1(i,j,k)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;after y&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!because (100)
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!so the post processing in x is different
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!from the  y and z
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! POST PROCESSING IN X
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          cw1b(<span style="color:#ae81ff">1</span>,j,k)<span style="color:#f92672">=</span>cw1(<span style="color:#ae81ff">1</span>,j,k)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,nx
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             tmp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k), kind<span style="color:#f92672">=</span>mytype) <span style="color:#75715e">!!! the 2~nx
</span><span style="color:#75715e"></span>             tmp4 <span style="color:#f92672">=</span> aimag(cw1(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k))    <span style="color:#75715e">!!!!!!!!!!!!     2~nx
</span><span style="color:#75715e"></span>             xx1<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx2<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>ax(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx3<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx4<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>ax(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx5<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx6<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>ax(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx7<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx8<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>ax(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             cw1b(i,j,k) <span style="color:#f92672">=</span> cmplx(xx1<span style="color:#f92672">+</span>xx4<span style="color:#f92672">+</span>xx5<span style="color:#f92672">-</span>xx8,<span style="color:#f92672">-</span>xx2<span style="color:#f92672">+</span>xx3<span style="color:#f92672">+</span>xx6<span style="color:#f92672">+</span>xx7, &amp;
                  kind<span style="color:#f92672">=</span>mytype)  
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!  While  you set the -Debug in the compile period
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1b(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;after x&#39;</span>,i,j,k,cw1b(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!from now on, the cw1b in x,y,z direction(not pencil)
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!is calculated ,so now you can calculate cw1b in the
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!! poisson condition ,yes poisson solver
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! Solve Poisson
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#75715e">!tmp1=real(zk2(k)+yk2(j)+xk2(i), kind=mytype)
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!tmp2=aimag(zk2(k)+yk2(j)+xk2(i))
</span><span style="color:#75715e"></span>             tmp1<span style="color:#f92672">=</span><span style="color:#66d9ef">real</span>(kxyz(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2<span style="color:#f92672">=</span>aimag(kxyz(i,j,k))
             <span style="color:#75715e">!xyzk=cmplx(tmp1,tmp2, kind=mytype)
</span><span style="color:#75715e"></span>             <span style="color:#75715e">! CANNOT DO A DIVISION BY ZERO
</span><span style="color:#75715e"></span><span style="color:#75715e">! yes
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> ((abs(tmp1).lt.epsilon).and.(abs(tmp2).lt.epsilon)) <span style="color:#66d9ef">then    
</span><span style="color:#66d9ef">                </span>cw1b(i,j,k)<span style="color:#f92672">=</span>cmplx(<span style="color:#ae81ff">0._mytype</span>,<span style="color:#ae81ff">0._mytype</span>, kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">if</span> ((abs(tmp1).lt.epsilon).and.(abs(tmp2).ge.epsilon)) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span>cw1b(i,j,k)<span style="color:#f92672">=</span>cmplx(<span style="color:#ae81ff">0._mytype</span>, &amp;
                     aimag(cw1b(i,j,k))<span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp2), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">if</span> ((abs(tmp1).ge.epsilon).and.(abs(tmp2).lt.epsilon)) <span style="color:#66d9ef">then    
</span><span style="color:#66d9ef">                </span>cw1b(i,j,k)<span style="color:#f92672">=</span>cmplx( <span style="color:#66d9ef">real</span>(cw1b(i,j,k), kind<span style="color:#f92672">=</span>mytype) &amp;
                     <span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp1), <span style="color:#ae81ff">0._mytype</span>, kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if</span>
             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!the most dayly processing
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> ((abs(tmp1).ge.epsilon).and.(abs(tmp2).ge.epsilon)) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span>cw1b(i,j,k)<span style="color:#f92672">=</span>cmplx( <span style="color:#66d9ef">real</span>(cw1b(i,j,k), kind<span style="color:#f92672">=</span>mytype) &amp;
                     <span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp1), &amp;
                     aimag(cw1b(i,j,k))<span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp2), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if</span>
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1b(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;AFTER&#39;</span>,i,j,k,cw1b(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
    
    <span style="color:#75715e">! post-processing backward
</span><span style="color:#75715e"></span>
<span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!  You know cw1b is the cw1&#39;s another form in the spectral
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!! space ,so you need to change the spetral space to physical
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!! space again ,yes get the cw1
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!! from now on ,you will found that the calculate of poisson
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!! equation is in the spectral space ,from the fft,then 3 post
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!! processing in x,y,z 3 directions, then calculate the  poisson
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!! equation. OK,then you start next!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! POST PROCESSING IN X
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          cw1(<span style="color:#ae81ff">1</span>,j,k)<span style="color:#f92672">=</span>cw1b(<span style="color:#ae81ff">1</span>,j,k)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,nx
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1b(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1b(i,j,k))
             tmp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1b(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp4 <span style="color:#f92672">=</span> aimag(cw1b(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k))
             xx1<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>bx(i)
             xx2<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>ax(i)
             xx3<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>bx(i)
             xx4<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>ax(i)
             xx5<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>bx(i)
             xx6<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>ax(i)
             xx7<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>bx(i)
             xx8<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>ax(i)
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(xx1<span style="color:#f92672">-</span>xx4<span style="color:#f92672">+</span>xx6<span style="color:#f92672">+</span>xx7,<span style="color:#f92672">-</span>(<span style="color:#f92672">-</span>xx2<span style="color:#f92672">-</span>xx3<span style="color:#f92672">+</span>xx5<span style="color:#f92672">-</span>xx8), &amp;
                  kind<span style="color:#f92672">=</span>mytype)        
              <span style="color:#75715e">!!!!!the buterfly algorithm!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!from now on x direction ,the spectral data has been transform to
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!! physical space, but still the complex
</span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;AFTER X&#39;</span>,i,j,k,cw1(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! POST PROCESSING IN Y
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">-</span>tmp2<span style="color:#f92672">*</span>ay(j), &amp;
                  tmp2<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">+</span>tmp1<span style="color:#f92672">*</span>ay(j), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">if</span> (j.gt.(ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) cw1(i,j,k)<span style="color:#f92672">=</span><span style="color:#f92672">-</span>cw1(i,j,k)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;AFTER Y&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

                                    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!! by  ay
</span><span style="color:#75715e"></span>                                    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!! bz  az
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! POST PROCESSING IN Z
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">-</span>tmp2<span style="color:#f92672">*</span>az(k), &amp;
                  tmp2<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">+</span>tmp1<span style="color:#f92672">*</span>az(k), kind<span style="color:#f92672">=</span>mytype)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;END&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">! compute c2r transform
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>decomp_2d_fft_3d(cw1,rhs)

    <span style="color:#75715e">! rhs is in Z-pencil but requires global operations in X
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_z_to_y(rhs,rw2,ph)
    <span style="color:#66d9ef">call </span>transpose_y_to_x(rw2,rw1,ph)
    <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>ph%xst(<span style="color:#ae81ff">3</span>),ph%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span>ph%xst(<span style="color:#ae81ff">2</span>),ph%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw1b(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,j,k)<span style="color:#f92672">=</span>rw1(i,j,k)   <span style="color:#75715e">! the odd terms is setted!
</span><span style="color:#75715e"></span>          enddo
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw1b(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>i,j,k)<span style="color:#f92672">=</span>rw1(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,j,k)  <span style="color:#75715e">! the even terms is setted
</span><span style="color:#75715e"></span>          enddo
       enddo
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">call </span>transpose_x_to_y(rw1b,rw2,ph)
    <span style="color:#66d9ef">call </span>transpose_y_to_z(rw2,rhs,ph)
<span style="color:#75715e">!!!!!!!!!!!!!the finally outcome rhs
</span><span style="color:#75715e"></span>    
  <span style="color:#75715e">!  call decomp_2d_fft_finalize
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return
</span><span style="color:#66d9ef">  </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>poisson_100

  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Neumann!!!!!!!!!!!!!!!!!!!!!!!!!!!111
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span> 
  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">! Solving 3D Poisson equation: Neumann in Y; periodic in X &amp; Z
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">subroutine </span>poisson_010(rhs)

    <span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">dimension</span>(:,:,:), <span style="color:#66d9ef">intent</span>(INOUT) <span style="color:#66d9ef">::</span> rhs

    <span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> xyzk
    <span style="color:#66d9ef">real</span>(mytype) <span style="color:#66d9ef">::</span> tmp1, tmp2, tmp3, tmp4
    <span style="color:#66d9ef">real</span>(mytype) <span style="color:#66d9ef">::</span> xx1,xx2,xx3,xx4,xx5,xx6,xx7,xx8

    <span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">::</span> nx,ny,nz, i,j,k

<span style="color:#ae81ff">100</span> <span style="color:#66d9ef">format</span>(<span style="color:#ae81ff">1</span>x,a8,<span style="color:#ae81ff">3</span>I4,<span style="color:#ae81ff">2</span>F12.<span style="color:#ae81ff">6</span>)

    nx <span style="color:#f92672">=</span> nx_global
    ny <span style="color:#f92672">=</span> ny_global <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e">! (010)  so have fewer1 ny!
</span><span style="color:#75715e"></span>    nz <span style="color:#f92672">=</span> nz_global

    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!so if (11*)  you need to ?what pencil??????
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!??
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! rhs is in Z-pencil but requires global operations in Y  because(010)
</span><span style="color:#75715e"></span>
                   <span style="color:#75715e">!!!!!!!!!!!!!!twice real to complex
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 1: transform rhs-rw2-rw1
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 2: fft       rhs-----rw1
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!!!twice complex to real
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 1: transfrom rw1-rw2--rhs
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 2: fft       rw1------rhs
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!! post-processing operations is under the complex condition
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   input real rhs(:.:,:) in the z pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1+1 transform  z-&gt;y y-&gt;z  |destination: modify the rhs  because z-y=1  rather than z-x=2
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 normalisation
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 FFT forward
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   2 post-processing   z--&gt;x  direction not pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 transform z-y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 post-processing   y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 poisson solver
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 matrice_refinement
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   3 inversion5_v1  inversion5_v2
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 post-processing backward  Y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 transform y-z
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   2 post-processing backward  x----&gt;z  direction
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 FFT backward
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1+1 transform    |destination: modify the rhs
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   output real rhs(:,:,:)  in the z pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!!!!!!!so the key factor  a  a2  a3    ax bx
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! ay by
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! az bz
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">call </span>transpose_z_to_y(rhs,rw2,ph)
    <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>ph%yst(<span style="color:#ae81ff">3</span>),ph%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>ph%yst(<span style="color:#ae81ff">1</span>),ph%yen(<span style="color:#ae81ff">1</span>)
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw2b(i,j,k)<span style="color:#f92672">=</span>rw2(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>(j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k)
          enddo
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span>ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,ny
             rw2b(i,j,k)<span style="color:#f92672">=</span>rw2(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k)
          enddo
       enddo
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">call </span>transpose_y_to_z(rw2b,rhs,ph)

    <span style="color:#66d9ef">if</span> (.not. fft_initialised) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>decomp_2d_fft_init(PHYSICAL_IN_Z,nx,ny,nz)
       fft_initialised <span style="color:#f92672">=</span> .true.
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if</span>
    <span style="color:#75715e">! compute r2c transform
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>decomp_2d_fft_3d(rhs,cw1)
    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! normalisation
</span><span style="color:#75715e"></span>    cw1 <span style="color:#f92672">=</span> cw1 <span style="color:#f92672">/</span> <span style="color:#66d9ef">real</span>(nx, kind<span style="color:#f92672">=</span>mytype) <span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(ny, kind<span style="color:#f92672">=</span>mytype) &amp;
         <span style="color:#f92672">/</span> <span style="color:#66d9ef">real</span>(nz, kind<span style="color:#f92672">=</span>mytype)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;START&#39;</span>,i,j,k,cw1(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! post-processing in spectral space
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! POST PROCESSING IN Z
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>az(k), &amp;
                  tmp2<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>az(k), kind<span style="color:#f92672">=</span>mytype)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;after z&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">! POST PROCESSING IN X
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>ax(i), &amp;
                  tmp2<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>ax(i), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">if</span> (i.gt.(nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) cw1(i,j,k)<span style="color:#f92672">=</span><span style="color:#f92672">-</span>cw1(i,j,k)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;after x&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
    
    <span style="color:#75715e">! POST PROCESSING IN Y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! NEED TO BE IN Y PENCILS!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!sp!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_x_to_y(cw1,cw2,sp)

    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!sp!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
          cw2b(i,<span style="color:#ae81ff">1</span>,k)<span style="color:#f92672">=</span>cw2(i,<span style="color:#ae81ff">1</span>,k)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,ny      
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw2(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw2(i,j,k))
             tmp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)
             tmp4 <span style="color:#f92672">=</span> aimag(cw2(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k))
             xx1<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx2<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>ay(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx3<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx4<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>ay(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx5<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx6<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>ay(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx7<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx8<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>ay(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             cw2b(i,j,k) <span style="color:#f92672">=</span> cmplx(xx1<span style="color:#f92672">+</span>xx4<span style="color:#f92672">+</span>xx5<span style="color:#f92672">-</span>xx8,<span style="color:#f92672">-</span>xx2<span style="color:#f92672">+</span>xx3<span style="color:#f92672">+</span>xx6<span style="color:#f92672">+</span>xx7, &amp;
                  kind<span style="color:#f92672">=</span>mytype)
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">2</span>), sp%yen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw2b(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;after y&#39;</span>,i,j,k,cw2b(i,j,k)
                <span style="color:#66d9ef">print</span> <span style="color:#f92672">*</span>,kxyz(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (istret<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then</span>

    <span style="color:#75715e">! Solve Poisson
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! doing wave number division in Y-pencil
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">2</span>), sp%yen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             <span style="color:#75715e">!tmp1=real(zk2(k)+yk2(j)+xk2(i), kind=mytype)
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!tmp2=aimag(zk2(k)+yk2(j)+xk2(i))
</span><span style="color:#75715e"></span>             tmp1<span style="color:#f92672">=</span><span style="color:#66d9ef">real</span>(kxyz(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2<span style="color:#f92672">=</span>aimag(kxyz(i,j,k))
             <span style="color:#75715e">!xyzk=cmplx(tmp1,tmp2, kind=mytype)
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!CANNOT DO A DIVISION BY ZERO
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> ((abs(tmp1).lt.epsilon).and.(abs(tmp2).lt.epsilon)) <span style="color:#66d9ef">then    
</span><span style="color:#66d9ef">                </span>cw2b(i,j,k)<span style="color:#f92672">=</span>cmplx(<span style="color:#ae81ff">0._mytype</span>,<span style="color:#ae81ff">0._mytype</span>, kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">if</span> ((abs(tmp1).lt.epsilon).and.(abs(tmp2).ge.epsilon)) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span>cw2b(i,j,k)<span style="color:#f92672">=</span>cmplx(<span style="color:#ae81ff">0._mytype</span>, &amp;
                     aimag(cw2b(i,j,k))<span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp2), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">if</span> ((abs(tmp1).ge.epsilon).and.(abs(tmp2).lt.epsilon)) <span style="color:#66d9ef">then    
</span><span style="color:#66d9ef">                </span>cw2b(i,j,k)<span style="color:#f92672">=</span>cmplx( <span style="color:#66d9ef">real</span>(cw2b(i,j,k), kind<span style="color:#f92672">=</span>mytype) &amp;
                     <span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp1), <span style="color:#ae81ff">0._mytype</span>, kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">if</span> ((abs(tmp1).ge.epsilon).and.(abs(tmp2).ge.epsilon)) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span>cw2b(i,j,k)<span style="color:#f92672">=</span>cmplx( <span style="color:#66d9ef">real</span>(cw2b(i,j,k), kind<span style="color:#f92672">=</span>mytype) &amp;
                     <span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp1), &amp;
                     aimag(cw2b(i,j,k))<span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp2), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">else</span>
       
        <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">call </span>matrice_refinement()
        <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span><span style="color:#75715e">!       do k = sp%yst(3), sp%yen(3)
</span><span style="color:#75715e"></span><span style="color:#75715e">!          do j = 1,ny/2
</span><span style="color:#75715e"></span><span style="color:#75715e">!             do i = sp%yst(1), sp%yen(1)
</span><span style="color:#75715e"></span><span style="color:#75715e">!                print *,i,j,k,a(i,j,k,3)
</span><span style="color:#75715e"></span><span style="color:#75715e">!!                if (nrank.le.1) print *,i,j,k,a(i,j,k,3)
</span><span style="color:#75715e"></span><span style="color:#75715e">!!                if (nrank.gt.1) print *,i+4,j,k,a(i,j,k,3)
</span><span style="color:#75715e"></span><span style="color:#75715e">!             enddo
</span><span style="color:#75715e"></span><span style="color:#75715e">!          enddo
</span><span style="color:#75715e"></span><span style="color:#75715e">!       enddo
</span><span style="color:#75715e"></span>     


<span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!istret  !=3
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">if</span> (istret.ne.<span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">          </span>cw2(:,:,:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>;cw2c(:,:,:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
          <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2(i,j,k)<span style="color:#f92672">=</span>cw2b(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k)
             cw2c(i,j,k)<span style="color:#f92672">=</span>cw2b(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j,k)
          enddo
          enddo
          enddo

 <span style="color:#75715e">!   do k = sp%yst(3), sp%yen(3)
</span><span style="color:#75715e"></span> <span style="color:#75715e">!      do j = 1,ny/2
</span><span style="color:#75715e"></span> <span style="color:#75715e">!         do i = sp%yst(1), sp%yen(1)
</span><span style="color:#75715e"></span> <span style="color:#75715e">!            if (abs(cw2(i,j,k)) &gt; 1.0e-4) then
</span><span style="color:#75715e"></span> <span style="color:#75715e">!               write(*,*) &#39;before IN&#39;,i,j,k,cw2(i,j,k)!*2.
</span><span style="color:#75715e"></span> <span style="color:#75715e">!!            end if
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!        end do
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!     end do
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!  end do
</span><span style="color:#75715e"></span>          
  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!for the strech  grid!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>         <span style="color:#66d9ef">call </span>inversion5_v1(a,cw2,sp)
         <span style="color:#66d9ef">call </span>inversion5_v1(a2,cw2c,sp)

<span style="color:#75715e">!         cw2(1,1,1)=cw2(1,1,1)*0.5
</span><span style="color:#75715e"></span>         
 
<span style="color:#75715e">!   do k = sp%yst(3), sp%yen(3)
</span><span style="color:#75715e"></span><span style="color:#75715e">!       do j = 1,ny/2
</span><span style="color:#75715e"></span><span style="color:#75715e">!          do i = sp%yst(1), sp%yen(1)
</span><span style="color:#75715e"></span><span style="color:#75715e">!             if (abs(cw2c(i,j,k)) &gt; 1.0e-4) then
</span><span style="color:#75715e"></span><span style="color:#75715e">!                write(*,*) &#39;after IN&#39;,i,j,k,cw2c(i,j,k)!*2.
</span><span style="color:#75715e"></span><span style="color:#75715e">!             end if
</span><span style="color:#75715e"></span><span style="color:#75715e">!          end do
</span><span style="color:#75715e"></span><span style="color:#75715e">!       end do
</span><span style="color:#75715e"></span><span style="color:#75715e">!    end do
</span><span style="color:#75715e"></span>
          cw2b(:,:,:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
          <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2b(i,j,k)<span style="color:#f92672">=</span>cw2(i,(j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k)
          enddo
          enddo
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,ny,<span style="color:#ae81ff">2</span>
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2b(i,j,k)<span style="color:#f92672">=</span>cw2c(i,j<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k)
          enddo
          enddo
          enddo
          <span style="color:#75715e">!do k=sp%yst(3), sp%yen(3)
</span><span style="color:#75715e"></span>          <span style="color:#75715e">!do i=sp%yst(1), sp%yen(1)
</span><span style="color:#75715e"></span>          <span style="color:#75715e">!   if ((xkx(i)==0).and.(zkz(k)==0)) then
</span><span style="color:#75715e"></span>          <span style="color:#75715e">!   !   cw2b(i,1,1)=0.
</span><span style="color:#75715e"></span>          <span style="color:#75715e">!   !   cw2b(i,ny,1)=0.
</span><span style="color:#75715e"></span>          <span style="color:#75715e">!   endif
</span><span style="color:#75715e"></span>          <span style="color:#75715e">!enddo
</span><span style="color:#75715e"></span>          <span style="color:#75715e">!enddo
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">else
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,ny
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2(i,j,k)<span style="color:#f92672">=</span>cw2b(i,j,k)
          enddo
          enddo
          enddo
          <span style="color:#66d9ef">call </span>inversion5_v2(a3,cw2,sp)
          <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,ny
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2b(i,j,k)<span style="color:#f92672">=</span>cw2(i,j,k)
          enddo
          enddo
          enddo
       endif

    endif

<span style="color:#75715e">!    print *,nrank, sp%yst(3),sp%yen(3),sp%yst(1),sp%yen(1)
</span><span style="color:#75715e"></span>
<span style="color:#75715e">!we are in Y pencil
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)  
    <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
       <span style="color:#66d9ef">if</span> ((i<span style="color:#f92672">==</span>nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>).and.(k<span style="color:#f92672">==</span>nz<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">          </span>cw2b(i,:,k)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
       endif
    enddo
    enddo
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">2</span>), sp%yen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw2b(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;AFTER&#39;</span>,i,j,k,cw2b(i,j,k)
                <span style="color:#66d9ef">print</span> <span style="color:#f92672">*</span>,kxyz(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! post-processing backward
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! POST PROCESSING IN Y
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
          cw2(i,<span style="color:#ae81ff">1</span>,k)<span style="color:#f92672">=</span>cw2b(i,<span style="color:#ae81ff">1</span>,k)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,ny
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw2b(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw2b(i,j,k))
             tmp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw2b(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)
             tmp4 <span style="color:#f92672">=</span> aimag(cw2b(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k))
             xx1<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>by(j)
             xx2<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>ay(j)
             xx3<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>by(j)
             xx4<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>ay(j)
             xx5<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>by(j)
             xx6<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>ay(j)
             xx7<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>by(j)
             xx8<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>ay(j)
             cw2(i,j,k) <span style="color:#f92672">=</span> cmplx(xx1<span style="color:#f92672">-</span>xx4<span style="color:#f92672">+</span>xx6<span style="color:#f92672">+</span>xx7,<span style="color:#f92672">-</span>(<span style="color:#f92672">-</span>xx2<span style="color:#f92672">-</span>xx3<span style="color:#f92672">+</span>xx5<span style="color:#f92672">-</span>xx8), &amp;
                  kind<span style="color:#f92672">=</span>mytype)
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
           
    <span style="color:#75715e">! Back to X-pencil
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_y_to_x(cw2,cw1,sp)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;AFTER Y&#39;</span>,i,j,k,cw1(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>    
    <span style="color:#75715e">! POST PROCESSING IN X
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">-</span>tmp2<span style="color:#f92672">*</span>ax(i), &amp;
                  tmp2<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">+</span>tmp1<span style="color:#f92672">*</span>ax(i), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">if</span> (i.gt.(nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) cw1(i,j,k)<span style="color:#f92672">=</span><span style="color:#f92672">-</span>cw1(i,j,k)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;AFTER X&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">! POST PROCESSING IN Z
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">-</span>tmp2<span style="color:#f92672">*</span>az(k), &amp;
                  tmp2<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">+</span>tmp1<span style="color:#f92672">*</span>az(k), kind<span style="color:#f92672">=</span>mytype)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;END&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">! compute c2r transform, back to physical space
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">call </span>decomp_2d_fft_3d(cw1,rhs)

    <span style="color:#75715e">! rhs is in Z-pencil but requires global operations in Y
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_z_to_y(rhs,rw2,ph)
    <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>ph%yst(<span style="color:#ae81ff">3</span>),ph%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>ph%yst(<span style="color:#ae81ff">1</span>),ph%yen(<span style="color:#ae81ff">1</span>)
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw2b(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k)<span style="color:#f92672">=</span>rw2(i,j,k)
          enddo
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw2b(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j,k)<span style="color:#f92672">=</span>rw2(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k)
          enddo
       enddo
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">call </span>transpose_y_to_z(rw2b,rhs,ph)

  <span style="color:#75715e">!  call decomp_2d_fft_finalize
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return
</span><span style="color:#66d9ef">  </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>poisson_010

  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!Neumann!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!11x!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!Neumann Neumann Neumann!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!Neumann Neumann periodic!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#75715e">! Solving 3D Poisson equation: Neumann in X, Y; Neumann/periodic in Z
</span><span style="color:#75715e"></span>  <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">subroutine </span>poisson_11x(rhs, nclz1)




                   <span style="color:#75715e">!!!!!!!!!!!!!!twice real to complex
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 1: transform rhs-rw2-rw1
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 2: fft       rhs-----rw1
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!!!twice complex to real
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 1: transfrom rw1-rw2--rhs
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">!!!!!!!!!!! 2: fft       rw1------rhs
</span><span style="color:#75715e"></span>                   <span style="color:#75715e">!!!!!!!!!!!!! post-processing operations is under the complex condition
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   input real rhs(:.:,:) in the z pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   2+2 transform    z--y  y-&gt;x   x-y y-z|destination: modify the rhs
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 normalisation
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 FFT forward
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 post-processing  z
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 transpose  x--y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 post-processing  y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 transpose  y--x
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 post-processing  x (because  he thinks he is in X pencil, Zhaoliang said no)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 poisson solver
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 matrice_refinemento
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 transpse   x--y  (for strecting  because strecthing is in the y direction)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 inversion5_v1
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 transpose  y---x
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!  
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 post-processing x
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 transpose  x-y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 post-processing y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 transpose  y-x
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 post-processing z
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   1 FFT backward
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   2+2 transform    |destination: modify the rhs
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!   output real rhs(:,:,:)  in the z pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>


    <span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">integer</span>, <span style="color:#66d9ef">intent</span>(IN) <span style="color:#66d9ef">::</span> nclz1    
    <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">dimension</span>(:,:,:), <span style="color:#66d9ef">intent</span>(INOUT) <span style="color:#66d9ef">::</span> rhs

    <span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> xyzk
    <span style="color:#66d9ef">real</span>(mytype) <span style="color:#66d9ef">::</span> tmp1, tmp2, tmp3, tmp4
    <span style="color:#66d9ef">real</span>(mytype) <span style="color:#66d9ef">::</span> xx1,xx2,xx3,xx4,xx5,xx6,xx7,xx8

    <span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">::</span> nx,ny,nz, i,j,k

<span style="color:#ae81ff">100</span> <span style="color:#66d9ef">format</span>(<span style="color:#ae81ff">1</span>x,a8,<span style="color:#ae81ff">3</span>I4,<span style="color:#ae81ff">2</span>F12.<span style="color:#ae81ff">6</span>)

    nx <span style="color:#f92672">=</span> nx_global <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>   <span style="color:#75715e">! becasuse (110)
</span><span style="color:#75715e"></span>    ny <span style="color:#f92672">=</span> ny_global <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>

    <span style="color:#66d9ef">if</span> (nclz1<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then</span>     <span style="color:#75715e">!!!!!the free-slip boundary condition
</span><span style="color:#75715e"></span>       nz <span style="color:#f92672">=</span> nz_global <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (nclz1<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span>nz <span style="color:#f92672">=</span> nz_global
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">   
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">if</span> (nclz1<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then  
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ph%zsz(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ph%zsz(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nz<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
                rw3(i,j,k)<span style="color:#f92672">=</span>rhs(i,j,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>(k<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>nz<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,nz
                rw3(i,j,k)<span style="color:#f92672">=</span>rhs(i,j,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>nz<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>k<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>transpose_z_to_y(rw3,rw2,ph)
    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (nclz1<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then     
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>transpose_z_to_y(rhs,rw2,ph)
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">    
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>ph%yst(<span style="color:#ae81ff">3</span>),ph%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>ph%yst(<span style="color:#ae81ff">1</span>),ph%yen(<span style="color:#ae81ff">1</span>)
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw2b(i,j,k)<span style="color:#f92672">=</span>rw2(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>(j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k)
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span>ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,ny
             rw2b(i,j,k)<span style="color:#f92672">=</span>rw2(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k)
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">! the global operations in X
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_y_to_x(rw2b,rw1,ph)

    <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>ph%xst(<span style="color:#ae81ff">3</span>),ph%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span>ph%xst(<span style="color:#ae81ff">2</span>),ph%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw1b(i,j,k)<span style="color:#f92672">=</span>rw1(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>(i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,j,k)
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,nx
             rw1b(i,j,k)<span style="color:#f92672">=</span>rw1(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>nx<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k)
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">! back to Z-pencil
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_x_to_y(rw1b,rw2,ph)
    <span style="color:#66d9ef">call </span>transpose_y_to_z(rw2,rhs,ph)

    <span style="color:#66d9ef">if</span> (.not. fft_initialised) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>decomp_2d_fft_init(PHYSICAL_IN_Z,nx,ny,nz)
       fft_initialised <span style="color:#f92672">=</span> .true.
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if</span>

    <span style="color:#75715e">! compute r2c transform
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">call </span>decomp_2d_fft_3d(rhs,cw1)



    <span style="color:#75715e">! normalisation
</span><span style="color:#75715e"></span>    cw1 <span style="color:#f92672">=</span> cw1 <span style="color:#f92672">/</span> <span style="color:#66d9ef">real</span>(nx, kind<span style="color:#f92672">=</span>mytype) <span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(ny, kind<span style="color:#f92672">=</span>mytype) &amp;
         <span style="color:#f92672">/</span> <span style="color:#66d9ef">real</span>(nz, kind<span style="color:#f92672">=</span>mytype)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;START&#39;</span>,i,j,k,cw1(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! post-processing in spectral space
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! POST PROCESSING IN Z
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">*</span>az(k), &amp;
                  tmp2<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">-</span>tmp1<span style="color:#f92672">*</span>az(k), kind<span style="color:#f92672">=</span>mytype)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;after z&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>


    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!while  1  should be in the corresponding pencils
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!characteristic 2 : there sholud be tmp1*2*3*4
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! POST PROCESSING IN Y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! WE HAVE TO BE IN Y PENCILS
</span><span style="color:#75715e"></span>


    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!No  we should be the z pencil!  
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!there is something wrong in the source code!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!But now we are in the z pencil not in
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  the x pencil!
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!so,it should be
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!call transpose_z_to_y rather than transpose_x_to_y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_x_to_y(cw1,cw2,sp)
    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
          cw2b(i,<span style="color:#ae81ff">1</span>,k)<span style="color:#f92672">=</span>cw2(i,<span style="color:#ae81ff">1</span>,k)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,ny
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw2(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw2(i,j,k))
             tmp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)
             tmp4 <span style="color:#f92672">=</span> aimag(cw2(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k))
             xx1<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx2<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>ay(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx3<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx4<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>ay(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx5<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx6<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>ay(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx7<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>by(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx8<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>ay(j)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             cw2b(i,j,k) <span style="color:#f92672">=</span> cmplx(xx1<span style="color:#f92672">+</span>xx4<span style="color:#f92672">+</span>xx5<span style="color:#f92672">-</span>xx8,<span style="color:#f92672">-</span>xx2<span style="color:#f92672">+</span>xx3<span style="color:#f92672">+</span>xx6<span style="color:#f92672">+</span>xx7, &amp;
                  kind<span style="color:#f92672">=</span>mytype)  
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
    
    <span style="color:#75715e">! back to X-pencil
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!the same wrong ,now you should
</span><span style="color:#75715e"></span>    <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!go back to the z pencil rather than the x pencil
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_y_to_x(cw2b,cw1,sp)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;after y&#39;</span>,i,j,k,cw1(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>    
    <span style="color:#75715e">! POST PROCESSING IN X
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          cw1b(<span style="color:#ae81ff">1</span>,j,k)<span style="color:#f92672">=</span>cw1(<span style="color:#ae81ff">1</span>,j,k)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,nx
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             tmp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp4 <span style="color:#f92672">=</span> aimag(cw1(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k))
             xx1<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx2<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>ax(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx3<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx4<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>ax(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx5<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx6<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>ax(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx7<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>bx(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             xx8<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>ax(i)<span style="color:#f92672">/</span><span style="color:#ae81ff">2._mytype</span>
             cw1b(i,j,k) <span style="color:#f92672">=</span> cmplx(xx1<span style="color:#f92672">+</span>xx4<span style="color:#f92672">+</span>xx5<span style="color:#f92672">-</span>xx8,<span style="color:#f92672">-</span>xx2<span style="color:#f92672">+</span>xx3<span style="color:#f92672">+</span>xx6<span style="color:#f92672">+</span>xx7, &amp;
                  kind<span style="color:#f92672">=</span>mytype)  
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
    
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1b(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#f92672">*</span>) <span style="color:#e6db74">&#39;BEFORE&#39;</span>,i,j,k,cw1b(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (istret<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then</span>

    <span style="color:#75715e">! Solve Poisson
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#75715e">!tmp1=real(zk2(k)+yk2(j)+xk2(i), kind=mytype)
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!tmp2=aimag(zk2(k)+yk2(j)+xk2(i))
</span><span style="color:#75715e"></span>             tmp1<span style="color:#f92672">=</span><span style="color:#66d9ef">real</span>(kxyz(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2<span style="color:#f92672">=</span>aimag(kxyz(i,j,k))
             <span style="color:#75715e">!xyzk=cmplx(tmp1,tmp2, kind=mytype)
</span><span style="color:#75715e"></span>             <span style="color:#75715e">!CANNOT DO A DIVISION BY ZERO
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> ((abs(tmp1).lt.epsilon).and.(abs(tmp2).lt.epsilon)) <span style="color:#66d9ef">then    
</span><span style="color:#66d9ef">                </span>cw1b(i,j,k)<span style="color:#f92672">=</span>cmplx(<span style="color:#ae81ff">0._mytype</span>,<span style="color:#ae81ff">0._mytype</span>, kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">if</span> ((abs(tmp1).lt.epsilon).and.(abs(tmp2).ge.epsilon)) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span>cw1b(i,j,k)<span style="color:#f92672">=</span>cmplx(<span style="color:#ae81ff">0._mytype</span>, &amp;
                     aimag(cw1b(i,j,k))<span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp2), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">if</span> ((abs(tmp1).ge.epsilon).and.(abs(tmp2).lt.epsilon)) <span style="color:#66d9ef">then    
</span><span style="color:#66d9ef">                </span>cw1b(i,j,k)<span style="color:#f92672">=</span>cmplx( <span style="color:#66d9ef">real</span>(cw1b(i,j,k), kind<span style="color:#f92672">=</span>mytype) &amp;
                     <span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp1), <span style="color:#ae81ff">0._mytype</span>, kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">if</span> ((abs(tmp1).ge.epsilon).and.(abs(tmp2).ge.epsilon)) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span>cw1b(i,j,k)<span style="color:#f92672">=</span>cmplx( <span style="color:#66d9ef">real</span>(cw1b(i,j,k), kind<span style="color:#f92672">=</span>mytype) &amp;
                     <span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp1), &amp;
                     aimag(cw1b(i,j,k))<span style="color:#f92672">/</span>(<span style="color:#f92672">-</span>tmp2), kind<span style="color:#f92672">=</span>mytype)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">else
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>matrice_refinement()
       <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11so       we  should  z-&gt;y pencil but not  x-&gt;ypencil
</span><span style="color:#75715e"></span><span style="color:#75715e">! the stretching is only working in Y pencils
</span><span style="color:#75715e"></span>
<span style="color:#75715e">!!!!!!!!!!!!!!!why the default the pencil is  x pencil rather than z pencil!!!
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">call </span>transpose_x_to_y(cw1b,cw2b,sp)
       <span style="color:#75715e">!we are now in Y pencil
</span><span style="color:#75715e"></span>       
       <span style="color:#66d9ef">if</span> (istret.ne.<span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">          </span>cw2(:,:,:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>;cw2c(:,:,:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
          <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2(i,j,k)<span style="color:#f92672">=</span>cw2b(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k)
             cw2c(i,j,k)<span style="color:#f92672">=</span>cw2b(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j,k)
          enddo
          enddo
          enddo
          <span style="color:#66d9ef">call </span>inversion5_v1(a,cw2,sp)
          <span style="color:#66d9ef">call </span>inversion5_v1(a2,cw2c,sp)

          cw2b(:,:,:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
          <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2b(i,j,k)<span style="color:#f92672">=</span>cw2(i,(j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k)
          enddo
          enddo
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,ny,<span style="color:#ae81ff">2</span>
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2b(i,j,k)<span style="color:#f92672">=</span>cw2c(i,j<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k)
          enddo
          enddo
          enddo
       <span style="color:#66d9ef">else
</span><span style="color:#66d9ef">          </span>cw2(:,:,:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
          <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">2</span>), sp%yen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2(i,j,k)<span style="color:#f92672">=</span>cw2b(i,j,k)
          enddo
          enddo
          enddo

          <span style="color:#66d9ef">call </span>inversion5_v2(a3,cw2,sp)

          <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">2</span>), sp%yen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             cw2b(i,j,k)<span style="color:#f92672">=</span>cw2(i,j,k)
          enddo
          enddo
          enddo
       endif
<span style="color:#75715e">!we have to go back in X pencils
</span><span style="color:#75715e"></span>       <span style="color:#66d9ef">call </span>transpose_y_to_x(cw2b,cw1b,sp)
    endif

<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1b(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-6</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#f92672">*</span>) <span style="color:#e6db74">&#39;AFTER&#39;</span>,i,j,k,cw1b(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span><span style="color:#75715e">!stop
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! post-processing backward
</span><span style="color:#75715e"></span>    
    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          cw1(<span style="color:#ae81ff">1</span>,j,k)<span style="color:#f92672">=</span>cw1b(<span style="color:#ae81ff">1</span>,j,k)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,nx
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1b(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1b(i,j,k))
             tmp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1b(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp4 <span style="color:#f92672">=</span> aimag(cw1b(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,j,k))
             xx1<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>bx(i)
             xx2<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>ax(i)
             xx3<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>bx(i)
             xx4<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>ax(i)
             xx5<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>bx(i)
             xx6<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>ax(i)
             xx7<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>bx(i)
             xx8<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>ax(i)
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(xx1<span style="color:#f92672">-</span>xx4<span style="color:#f92672">+</span>xx6<span style="color:#f92672">+</span>xx7,<span style="color:#f92672">-</span>(<span style="color:#f92672">-</span>xx2<span style="color:#f92672">-</span>xx3<span style="color:#f92672">+</span>xx5<span style="color:#f92672">-</span>xx8), &amp;
                  kind<span style="color:#f92672">=</span>mytype)        
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;AFTER X&#39;</span>,i,j,k,cw1(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">! POST PROCESSING IN Y
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! NEED to be in Y-pencil
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_x_to_y(cw1,cw2,sp)
    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
          cw2b(i,<span style="color:#ae81ff">1</span>,k)<span style="color:#f92672">=</span>cw2(i,<span style="color:#ae81ff">1</span>,k)
          <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,ny
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw2(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw2(i,j,k))
             tmp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)
             tmp4 <span style="color:#f92672">=</span> aimag(cw2(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k))
             xx1<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>by(j)
             xx2<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">*</span>ay(j)
             xx3<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>by(j)
             xx4<span style="color:#f92672">=</span>tmp2<span style="color:#f92672">*</span>ay(j)
             xx5<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>by(j)
             xx6<span style="color:#f92672">=</span>tmp3<span style="color:#f92672">*</span>ay(j)
             xx7<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>by(j)
             xx8<span style="color:#f92672">=</span>tmp4<span style="color:#f92672">*</span>ay(j)
             cw2b(i,j,k) <span style="color:#f92672">=</span> cmplx(xx1<span style="color:#f92672">-</span>xx4<span style="color:#f92672">+</span>xx6<span style="color:#f92672">+</span>xx7,<span style="color:#f92672">-</span>(<span style="color:#f92672">-</span>xx2<span style="color:#f92672">-</span>xx3<span style="color:#f92672">+</span>xx5<span style="color:#f92672">-</span>xx8), &amp;
                  kind<span style="color:#f92672">=</span>mytype)        
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">2</span>), sp%yen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">if</span> (abs(cw2b(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">                </span><span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;AFTER Y&#39;</span>,i,j,k,cw2b(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>    <span style="color:#75715e">! back to X-pencil
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>transpose_y_to_x(cw2b,cw1,sp)
    
    <span style="color:#75715e">! POST PROCESSING IN Z
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
             tmp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">real</span>(cw1(i,j,k), kind<span style="color:#f92672">=</span>mytype)
             tmp2 <span style="color:#f92672">=</span> aimag(cw1(i,j,k))
             cw1(i,j,k) <span style="color:#f92672">=</span> cmplx(tmp1<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">-</span>tmp2<span style="color:#f92672">*</span>az(k), &amp;
                  tmp2<span style="color:#f92672">*</span>bz(k)<span style="color:#f92672">+</span>tmp1<span style="color:#f92672">*</span>az(k), kind<span style="color:#f92672">=</span>mytype)
<span style="color:#75715e">#ifdef DEBUG
</span><span style="color:#75715e"></span>             <span style="color:#66d9ef">if</span> (abs(cw1(i,j,k)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.0e-4</span>) &amp;
                  <span style="color:#66d9ef">write</span>(<span style="color:#f92672">*</span>,<span style="color:#ae81ff">100</span>) <span style="color:#e6db74">&#39;END&#39;</span>,i,j,k,cw1(i,j,k)
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do</span>

    <span style="color:#75715e">! compute c2r transform, back to physical space
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">call </span>decomp_2d_fft_3d(cw1,rhs)

    <span style="color:#66d9ef">if</span> (nclz1<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ph%zsz(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ph%zsz(<span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nz<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
                rw3(i,j,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>k<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span>rhs(i,j,k)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">             </span><span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nz<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
                rw3(i,j,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>k)<span style="color:#f92672">=</span>rhs(i,j,nz<span style="color:#f92672">-</span>k<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
             <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>transpose_z_to_y(rw3,rw2,ph)
    <span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (nclz1<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">call </span>transpose_z_to_y(rhs,rw2,ph)   
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">    
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>ph%yst(<span style="color:#ae81ff">3</span>),ph%yen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>ph%yst(<span style="color:#ae81ff">1</span>),ph%yen(<span style="color:#ae81ff">1</span>)
          <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw2b(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k)<span style="color:#f92672">=</span>rw2(i,j,k)
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">          </span><span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw2b(i,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j,k)<span style="color:#f92672">=</span>rw2(i,ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k)
          <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">       </span>enddo
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">call </span>transpose_y_to_x(rw2b,rw1,ph)
    <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>ph%xst(<span style="color:#ae81ff">3</span>),ph%xen(<span style="color:#ae81ff">3</span>)
       <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span>ph%xst(<span style="color:#ae81ff">2</span>),ph%xen(<span style="color:#ae81ff">2</span>)
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw1b(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,j,k)<span style="color:#f92672">=</span>rw1(i,j,k)
          enddo
          <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
             rw1b(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>i,j,k)<span style="color:#f92672">=</span>rw1(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,j,k)
          enddo
       enddo
    <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">call </span>transpose_x_to_y(rw1b,rw2,ph)
    <span style="color:#66d9ef">call </span>transpose_y_to_z(rw2,rhs,ph)

  <span style="color:#75715e">!  call decomp_2d_fft_finalize
</span><span style="color:#75715e"></span>
   

    <span style="color:#66d9ef">return
</span><span style="color:#66d9ef">  </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>poisson_11x


 
  <span style="color:#66d9ef">subroutine </span>abxyz(ax,ay,az,bx,by,bz,nx,ny,nz,bcx,bcy,bcz)
    
    <span style="color:#66d9ef">use </span>param

    <span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">integer</span>, <span style="color:#66d9ef">intent</span>(IN) <span style="color:#66d9ef">::</span> nx,ny,nz
    <span style="color:#66d9ef">integer</span>, <span style="color:#66d9ef">intent</span>(IN) <span style="color:#66d9ef">::</span> bcx,bcy,bcz
    <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">dimension</span>(:), <span style="color:#66d9ef">intent</span>(OUT) <span style="color:#66d9ef">::</span> ax,bx
    <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">dimension</span>(:), <span style="color:#66d9ef">intent</span>(OUT) <span style="color:#66d9ef">::</span> ay,by
    <span style="color:#66d9ef">real</span>(mytype), <span style="color:#66d9ef">dimension</span>(:), <span style="color:#66d9ef">intent</span>(OUT) <span style="color:#66d9ef">::</span> az,bz

    <span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">::</span> i,j,k

    <span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx
           <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>           <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>           <span style="color:#75715e">!!!!!!!!!!!!!! generate the x direction coeficiency!!!!!!!!!!!
</span><span style="color:#75715e"></span>           <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>           <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span>          ax(i) <span style="color:#f92672">=</span> sin(<span style="color:#66d9ef">real</span>(i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(nx, kind<span style="color:#f92672">=</span>mytype))
          bx(i) <span style="color:#f92672">=</span> cos(<span style="color:#66d9ef">real</span>(i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(nx, kind<span style="color:#f92672">=</span>mytype))
       <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcx<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx
           <span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!one and a half of PI
</span><span style="color:#75715e"></span>          ax(i) <span style="color:#f92672">=</span> sin(<span style="color:#66d9ef">real</span>(i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0_mytype</span><span style="color:#f92672">/</span> &amp;
               <span style="color:#66d9ef">real</span>(nx, kind<span style="color:#f92672">=</span>mytype))
          bx(i) <span style="color:#f92672">=</span> cos(<span style="color:#66d9ef">real</span>(i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0_mytype</span><span style="color:#f92672">/</span> &amp;
               <span style="color:#66d9ef">real</span>(nx, kind<span style="color:#f92672">=</span>mytype))
       <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">if</span> (bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny
          ay(j) <span style="color:#f92672">=</span> sin(<span style="color:#66d9ef">real</span>(j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(ny, kind<span style="color:#f92672">=</span>mytype))
          by(j) <span style="color:#f92672">=</span> cos(<span style="color:#66d9ef">real</span>(j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(ny, kind<span style="color:#f92672">=</span>mytype))
       <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcy<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny
          ay(j) <span style="color:#f92672">=</span> sin(<span style="color:#66d9ef">real</span>(j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0_mytype</span><span style="color:#f92672">/</span> &amp;
               <span style="color:#66d9ef">real</span>(ny, kind<span style="color:#f92672">=</span>mytype))
          by(j) <span style="color:#f92672">=</span> cos(<span style="color:#66d9ef">real</span>(j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0_mytype</span><span style="color:#f92672">/</span> &amp;
               <span style="color:#66d9ef">real</span>(ny, kind<span style="color:#f92672">=</span>mytype))
       <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">if</span> (bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nz
          az(k) <span style="color:#f92672">=</span> sin(<span style="color:#66d9ef">real</span>(k<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(nz, kind<span style="color:#f92672">=</span>mytype))
          bz(k) <span style="color:#f92672">=</span> cos(<span style="color:#66d9ef">real</span>(k<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(nz, kind<span style="color:#f92672">=</span>mytype))
       <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">else </span><span style="color:#66d9ef">if</span> (bcz<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">       </span><span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nz
          az(k) <span style="color:#f92672">=</span> sin(<span style="color:#66d9ef">real</span>(k<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0_mytype</span><span style="color:#f92672">/</span> &amp;
               <span style="color:#66d9ef">real</span>(nz, kind<span style="color:#f92672">=</span>mytype))
          bz(k) <span style="color:#f92672">=</span> cos(<span style="color:#66d9ef">real</span>(k<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>PI<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0_mytype</span><span style="color:#f92672">/</span> &amp;
               <span style="color:#66d9ef">real</span>(nz, kind<span style="color:#f92672">=</span>mytype))
       <span style="color:#66d9ef">end </span><span style="color:#66d9ef">do
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">if
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">    </span><span style="color:#66d9ef">return
</span><span style="color:#66d9ef">  </span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>abxyz

<span style="color:#75715e">! ***********************************************************
</span><span style="color:#75715e"></span><span style="color:#75715e">!
</span><span style="color:#75715e"></span><span style="color:#66d9ef">subroutine </span>waves ()
<span style="color:#75715e">!
</span><span style="color:#75715e"></span><span style="color:#75715e">!***********************************************************
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">USE </span>derivX
<span style="color:#66d9ef">USE </span>derivY
<span style="color:#66d9ef">USE </span>derivZ
<span style="color:#66d9ef">USE </span>param
<span style="color:#66d9ef">USE </span>decomp_2d
<span style="color:#66d9ef">USE </span>variables
<span style="color:#66d9ef">use </span>decomp_2d_fft

<span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef"></span><span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">::</span> i,j,k
<span style="color:#66d9ef">real</span>(mytype) <span style="color:#66d9ef">::</span> w,wp,w1,w1p
<span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> xyzk
<span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> ytt,xtt,ztt,yt1,xt1,yt2,xt2
<span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> xtt1,ytt1,ztt1,zt1,zt2,tmp1,tmp2,tmp3
<span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> tmp4,tmp5,tmp6

xkx(:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span> ; xk2(:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span> ; yky(:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span> ; yk2(:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
zkz(:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span> ; zk2(:)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>

<span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span><span style="color:#75715e">!WAVE NUMBER IN X
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span><span style="color:#75715e">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (nclx<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">   </span><span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
      w<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">*</span>(i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>nx
      wp<span style="color:#f92672">=</span>acix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">*</span>sin(w<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>(bcix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dx)<span style="color:#f92672">*</span>sin(<span style="color:#ae81ff">3.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>w)
      wp<span style="color:#f92672">=</span>wp<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>alcaix6<span style="color:#f92672">*</span>cos(w))
      xkx(i)<span style="color:#f92672">=</span>cmplx(nx<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>xlx,nx<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>xlx, kind<span style="color:#f92672">=</span>mytype)
      exs(i)<span style="color:#f92672">=</span>cmplx(nx<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>xlx,nx<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>xlx, kind<span style="color:#f92672">=</span>mytype)
      xk2(i)<span style="color:#f92672">=</span>cmplx((nx<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>xlx)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,(nx<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>xlx)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, kind<span style="color:#f92672">=</span>mytype)
   enddo
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>nx<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,nx
      xkx(i)<span style="color:#f92672">=</span>xkx(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
      exs(i)<span style="color:#f92672">=</span>exs(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
      xk2(i)<span style="color:#f92672">=</span>xk2(nx<span style="color:#f92672">-</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
   enddo
<span style="color:#66d9ef">else
</span><span style="color:#66d9ef">   </span><span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nx
      w<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">*</span><span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>(i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>nxm
      wp<span style="color:#f92672">=</span>acix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">*</span>sin(w<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>(bcix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dx)<span style="color:#f92672">*</span>sin(<span style="color:#ae81ff">3.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>w)
      wp<span style="color:#f92672">=</span>wp<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>alcaix6<span style="color:#f92672">*</span>cos(w))
      xkx(i)<span style="color:#f92672">=</span>cmplx(nxm<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>xlx,nxm<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>xlx, kind<span style="color:#f92672">=</span>mytype)
      exs(i)<span style="color:#f92672">=</span>cmplx(nxm<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>xlx,nxm<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>xlx, kind<span style="color:#f92672">=</span>mytype)
      xk2(i)<span style="color:#f92672">=</span>cmplx((nxm<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>xlx)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,(nxm<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>xlx)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, kind<span style="color:#f92672">=</span>mytype)
   enddo
   xkx(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   exs(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   xk2(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
endif

<span style="color:#75715e">!WAVE NUMBER IN Y
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (ncly<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">   </span><span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
      w<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">*</span>(j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>ny
      wp<span style="color:#f92672">=</span>aciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">*</span>sin(w<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>(bciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dy)<span style="color:#f92672">*</span>sin(<span style="color:#ae81ff">3.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>w)
      wp<span style="color:#f92672">=</span>wp<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>alcaiy6<span style="color:#f92672">*</span>cos(w))
      <span style="color:#66d9ef">if</span> (istret<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) yky(j)<span style="color:#f92672">=</span>cmplx(ny<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>yly,ny<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>yly, kind<span style="color:#f92672">=</span>mytype)
      <span style="color:#66d9ef">if</span> (istret.ne.<span style="color:#ae81ff">0</span>) yky(j)<span style="color:#f92672">=</span>cmplx(ny<span style="color:#f92672">*</span>wp,ny<span style="color:#f92672">*</span>wp, kind<span style="color:#f92672">=</span>mytype)
      eys(j)<span style="color:#f92672">=</span>cmplx(ny<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>yly,ny<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>yly, kind<span style="color:#f92672">=</span>mytype)
      yk2(j)<span style="color:#f92672">=</span>cmplx((ny<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>yly)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,(ny<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>yly)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, kind<span style="color:#f92672">=</span>mytype)
   enddo
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span>ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,ny
      yky(j)<span style="color:#f92672">=</span>yky(ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
      eys(j)<span style="color:#f92672">=</span>eys(ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
      yk2(j)<span style="color:#f92672">=</span>yk2(ny<span style="color:#f92672">-</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
   enddo
<span style="color:#66d9ef">else
</span><span style="color:#66d9ef">   </span><span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny
      w<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">*</span><span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>(j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>nym
      wp<span style="color:#f92672">=</span>aciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">*</span>sin(w<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>(bciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dy)<span style="color:#f92672">*</span>sin(<span style="color:#ae81ff">3.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>w)
      wp<span style="color:#f92672">=</span>wp<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>alcaiy6<span style="color:#f92672">*</span>cos(w))
      <span style="color:#66d9ef">if</span> (istret<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) yky(j)<span style="color:#f92672">=</span>cmplx(nym<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>yly,nym<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>yly, kind<span style="color:#f92672">=</span>mytype)
      <span style="color:#66d9ef">if</span> (istret.ne.<span style="color:#ae81ff">0</span>) yky(j)<span style="color:#f92672">=</span>cmplx(nym<span style="color:#f92672">*</span>wp,nym<span style="color:#f92672">*</span>wp, kind<span style="color:#f92672">=</span>mytype)
      eys(j)<span style="color:#f92672">=</span>cmplx(nym<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>yly,nym<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>yly, kind<span style="color:#f92672">=</span>mytype)
      yk2(j)<span style="color:#f92672">=</span>cmplx((nym<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>yly)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,(nym<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>yly)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, kind<span style="color:#f92672">=</span>mytype)
   enddo
   yky(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   eys(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   yk2(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
endif

<span style="color:#75715e">!WAVE NUMBER IN Z
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (nclz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">   </span><span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nz<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
      w<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">*</span>(k<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>nz
      wp<span style="color:#f92672">=</span>aciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">*</span>sin(w<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>(bciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dz)<span style="color:#f92672">*</span>sin(<span style="color:#ae81ff">3.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>w)
      wp<span style="color:#f92672">=</span>wp<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>alcaiz6<span style="color:#f92672">*</span>cos(w))
      zkz(k)<span style="color:#f92672">=</span>cmplx(nz<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>zlz,nz<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>zlz, kind<span style="color:#f92672">=</span>mytype)
      ezs(k)<span style="color:#f92672">=</span>cmplx(nz<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>zlz,nz<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>zlz, kind<span style="color:#f92672">=</span>mytype)
      zk2(k)<span style="color:#f92672">=</span>cmplx((nz<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>zlz)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,(nz<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>zlz)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, kind<span style="color:#f92672">=</span>mytype)
   enddo
<span style="color:#66d9ef">else
</span><span style="color:#66d9ef">   </span><span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nz<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
      w<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">*</span><span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>(k<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>nzm
      w1<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>pi<span style="color:#f92672">*</span><span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>(nzm<span style="color:#f92672">-</span>k<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>nzm
      wp<span style="color:#f92672">=</span>aciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">*</span>sin(w<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>(bciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dz)<span style="color:#f92672">*</span>sin(<span style="color:#ae81ff">3.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>w)
      wp<span style="color:#f92672">=</span>wp<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>alcaiz6<span style="color:#f92672">*</span>cos(w))
      w1p<span style="color:#f92672">=</span>aciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">*</span>sin(w1<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>(bciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>dz)<span style="color:#f92672">*</span>sin(<span style="color:#ae81ff">3.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>w1)
      w1p<span style="color:#f92672">=</span>w1p<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>alcaiz6<span style="color:#f92672">*</span>cos(w1))     
      zkz(k)<span style="color:#f92672">=</span>cmplx(nzm<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>zlz,<span style="color:#f92672">-</span>nzm<span style="color:#f92672">*</span>w1p<span style="color:#f92672">/</span>zlz, kind<span style="color:#f92672">=</span>mytype)
      ezs(k)<span style="color:#f92672">=</span>cmplx(nzm<span style="color:#f92672">*</span>w<span style="color:#f92672">/</span>zlz,nzm<span style="color:#f92672">*</span>w1<span style="color:#f92672">/</span>zlz, kind<span style="color:#f92672">=</span>mytype)
      zk2(k)<span style="color:#f92672">=</span>cmplx((nzm<span style="color:#f92672">*</span>wp<span style="color:#f92672">/</span>zlz)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,(nzm<span style="color:#f92672">*</span>w1p<span style="color:#f92672">/</span>zlz)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, kind<span style="color:#f92672">=</span>mytype)
   enddo
endif
<span style="color:#75715e">!
</span><span style="color:#75715e"></span><span style="color:#75715e">!if (nrank==0) then
</span><span style="color:#75715e"></span><span style="color:#75715e">!   do i=1,nx
</span><span style="color:#75715e"></span><span style="color:#75715e">!      print *,i,ezs(i)
</span><span style="color:#75715e"></span><span style="color:#75715e">!   enddo
</span><span style="color:#75715e"></span><span style="color:#75715e">!endif
</span><span style="color:#75715e"></span><span style="color:#75715e">!stop
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">if</span> ((nclx<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>).and.(nclz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>).and.((ncly<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>).or.(ncly<span style="color:#f92672">==</span><span style="color:#ae81ff">2</span>))) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef"></span><span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>), sp%yen(<span style="color:#ae81ff">3</span>)
<span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">2</span>), sp%yen(<span style="color:#ae81ff">2</span>)
<span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>), sp%yen(<span style="color:#ae81ff">1</span>)
   xtt<span style="color:#f92672">=</span>cmplx((bicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i))<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        cicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (bicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        cicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   ytt<span style="color:#f92672">=</span>cmplx((biciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        ciciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (biciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        ciciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   ztt<span style="color:#f92672">=</span>cmplx((biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   xtt1<span style="color:#f92672">=</span>cmplx((aicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (aicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   ytt1<span style="color:#f92672">=</span>cmplx((aiciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (aiciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   ztt1<span style="color:#f92672">=</span>cmplx((aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   xt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaix6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx)),&amp;
        (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaix6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx)), kind<span style="color:#f92672">=</span>mytype)
   yt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiy6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy)),&amp;
        (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiy6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy)), kind<span style="color:#f92672">=</span>mytype)
   zt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz)),&amp;
        (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz)), kind<span style="color:#f92672">=</span>mytype)
   xt2<span style="color:#f92672">=</span>xk2(i)<span style="color:#f92672">*</span>((((ytt1<span style="color:#f92672">+</span>ytt)<span style="color:#f92672">/</span>yt1)<span style="color:#f92672">*</span>((ztt1<span style="color:#f92672">+</span>ztt)<span style="color:#f92672">/</span>zt1))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
   yt2<span style="color:#f92672">=</span>yk2(j)<span style="color:#f92672">*</span>((((xtt1<span style="color:#f92672">+</span>xtt)<span style="color:#f92672">/</span>xt1)<span style="color:#f92672">*</span>((ztt1<span style="color:#f92672">+</span>ztt)<span style="color:#f92672">/</span>zt1))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
   zt2<span style="color:#f92672">=</span>zk2(k)<span style="color:#f92672">*</span>((((xtt1<span style="color:#f92672">+</span>xtt)<span style="color:#f92672">/</span>xt1)<span style="color:#f92672">*</span>((ytt1<span style="color:#f92672">+</span>ytt)<span style="color:#f92672">/</span>yt1))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
   xyzk<span style="color:#f92672">=</span>xt2<span style="color:#f92672">+</span>yt2<span style="color:#f92672">+</span>zt2
   kxyz(i,j,k)<span style="color:#f92672">=</span>xyzk
<span style="color:#75715e">!   print *,i,j,k, kxyz(i,j,k)
</span><span style="color:#75715e"></span>enddo
enddo
enddo
<span style="color:#66d9ef">else
</span><span style="color:#66d9ef">   </span><span style="color:#66d9ef">if</span> (nclz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">      </span><span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
      <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
      <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)
         xtt<span style="color:#f92672">=</span>cmplx((bicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              cicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (bicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              cicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         ytt<span style="color:#f92672">=</span>cmplx((biciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              ciciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (biciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              ciciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         ztt<span style="color:#f92672">=</span>cmplx((biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         xtt1<span style="color:#f92672">=</span>cmplx((aicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (aicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         ytt1<span style="color:#f92672">=</span>cmplx((aiciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (aiciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         ztt1<span style="color:#f92672">=</span>cmplx((aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         xt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaix6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx)),&amp;
              (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaix6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i))<span style="color:#f92672">*</span>dx)), kind<span style="color:#f92672">=</span>mytype)
         yt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiy6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy)),&amp;
              (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiy6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy)), kind<span style="color:#f92672">=</span>mytype)
         zt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz)),&amp;
              (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz)), kind<span style="color:#f92672">=</span>mytype)
         xt2<span style="color:#f92672">=</span>xk2(i)<span style="color:#f92672">*</span>((((ytt1<span style="color:#f92672">+</span>ytt)<span style="color:#f92672">/</span>yt1)<span style="color:#f92672">*</span>((ztt1<span style="color:#f92672">+</span>ztt)<span style="color:#f92672">/</span>zt1))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
         yt2<span style="color:#f92672">=</span>yk2(j)<span style="color:#f92672">*</span>((((xtt1<span style="color:#f92672">+</span>xtt)<span style="color:#f92672">/</span>xt1)<span style="color:#f92672">*</span>((ztt1<span style="color:#f92672">+</span>ztt)<span style="color:#f92672">/</span>zt1))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
         zt2<span style="color:#f92672">=</span>zk2(k)<span style="color:#f92672">*</span>((((xtt1<span style="color:#f92672">+</span>xtt)<span style="color:#f92672">/</span>xt1)<span style="color:#f92672">*</span>((ytt1<span style="color:#f92672">+</span>ytt)<span style="color:#f92672">/</span>yt1))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
         xyzk<span style="color:#f92672">=</span>xt2<span style="color:#f92672">+</span>yt2<span style="color:#f92672">+</span>zt2
         kxyz(i,j,k)<span style="color:#f92672">=</span>xyzk
<span style="color:#75715e">!   print *,i,j,k, kxyz(i,j,k)
</span><span style="color:#75715e"></span>      enddo
      enddo
      enddo
   <span style="color:#66d9ef">else
</span><span style="color:#66d9ef">      </span><span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">3</span>),sp%xen(<span style="color:#ae81ff">3</span>)
      <span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">2</span>),sp%xen(<span style="color:#ae81ff">2</span>)
      <span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%xst(<span style="color:#ae81ff">1</span>),sp%xen(<span style="color:#ae81ff">1</span>)  
         xtt<span style="color:#f92672">=</span>cmplx((bicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              cicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (bicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              cicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         ytt<span style="color:#f92672">=</span>cmplx((biciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              ciciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (biciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              ciciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         <span style="color:#75715e">!
</span><span style="color:#75715e"></span>         ztt<span style="color:#f92672">=</span>cmplx((biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(aimag(ezs(k))<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
              ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(aimag(ezs(k))<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         <span style="color:#75715e">!
</span><span style="color:#75715e"></span>         xtt1<span style="color:#f92672">=</span>cmplx((aicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (aicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         ytt1<span style="color:#f92672">=</span>cmplx((aiciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (aiciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         <span style="color:#75715e">!
</span><span style="color:#75715e"></span>         ztt1<span style="color:#f92672">=</span>cmplx((aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
              (aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(aimag(ezs(k))<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
         <span style="color:#75715e">!
</span><span style="color:#75715e"></span>         xt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaix6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx)),&amp;
              (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaix6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx)), kind<span style="color:#f92672">=</span>mytype)
         yt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiy6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy)),&amp;
              (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiy6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy)), kind<span style="color:#f92672">=</span>mytype)
         zt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz)),&amp;
              (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(aimag(ezs(k))<span style="color:#f92672">*</span>dz)), kind<span style="color:#f92672">=</span>mytype)
         
         tmp1<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(ztt1<span style="color:#f92672">+</span>ztt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(zt1, kind<span style="color:#f92672">=</span>mytype),&amp;
              aimag(ztt1<span style="color:#f92672">+</span>ztt)<span style="color:#f92672">/</span>aimag(zt1), kind<span style="color:#f92672">=</span>mytype)
         tmp2<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(ytt1<span style="color:#f92672">+</span>ytt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(yt1, kind<span style="color:#f92672">=</span>mytype),&amp;
              <span style="color:#66d9ef">real</span>(ytt1<span style="color:#f92672">+</span>ytt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(yt1, kind<span style="color:#f92672">=</span>mytype), kind<span style="color:#f92672">=</span>mytype)
         tmp3<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(xtt1<span style="color:#f92672">+</span>xtt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(xt1, kind<span style="color:#f92672">=</span>mytype),&amp;
              <span style="color:#66d9ef">real</span>(xtt1<span style="color:#f92672">+</span>xtt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(xt1, kind<span style="color:#f92672">=</span>mytype), kind<span style="color:#f92672">=</span>mytype)
         
         tmp4<span style="color:#f92672">=</span>cmplx((<span style="color:#66d9ef">real</span>(tmp1, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(tmp2, kind<span style="color:#f92672">=</span>mytype))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,(aimag(tmp1)<span style="color:#f92672">*</span>aimag(tmp2))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, kind<span style="color:#f92672">=</span>mytype)
         tmp5<span style="color:#f92672">=</span>cmplx((<span style="color:#66d9ef">real</span>(tmp1, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(tmp3, kind<span style="color:#f92672">=</span>mytype))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,(aimag(tmp1)<span style="color:#f92672">*</span>aimag(tmp3))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, kind<span style="color:#f92672">=</span>mytype)
         tmp6<span style="color:#f92672">=</span>cmplx((<span style="color:#66d9ef">real</span>(tmp3, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(tmp2, kind<span style="color:#f92672">=</span>mytype))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,(aimag(tmp3)<span style="color:#f92672">*</span>aimag(tmp2))<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>, kind<span style="color:#f92672">=</span>mytype)
         
         tmp1<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(tmp4, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype),aimag(tmp4)<span style="color:#f92672">*</span>aimag(xk2(i)), kind<span style="color:#f92672">=</span>mytype)
         tmp2<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(tmp5, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(yk2(j), kind<span style="color:#f92672">=</span>mytype),aimag(tmp5)<span style="color:#f92672">*</span>aimag(yk2(j)), kind<span style="color:#f92672">=</span>mytype)
         tmp3<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(tmp6, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype),aimag(tmp6)<span style="color:#f92672">*</span>aimag(zk2(k)), kind<span style="color:#f92672">=</span>mytype)

         xyzk<span style="color:#f92672">=</span>tmp1<span style="color:#f92672">+</span>tmp2<span style="color:#f92672">+</span>tmp3
         kxyz(i,j,k)<span style="color:#f92672">=</span>xyzk
<span style="color:#75715e">!         print *,i,j,k,zt1,yt1
</span><span style="color:#75715e"></span>      enddo
      enddo
      enddo
   endif
endif


<span style="color:#75715e">!          do k=1,1!nz
</span><span style="color:#75715e"></span><span style="color:#75715e">!          do j=1,ny
</span><span style="color:#75715e"></span><span style="color:#75715e">!          do i=1,1!!nx
</span><span style="color:#75715e"></span><span style="color:#75715e">!             print *,j,a(i,j,k,3),kxyz(i,j,k)
</span><span style="color:#75715e"></span><span style="color:#75715e">!          enddo
</span><span style="color:#75715e"></span><span style="color:#75715e">!          enddo
</span><span style="color:#75715e"></span><span style="color:#75715e">!          enddo
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>waves

<span style="color:#75715e">!**************************************************************************
</span><span style="color:#75715e"></span><span style="color:#75715e">!
</span><span style="color:#75715e"></span><span style="color:#66d9ef">subroutine </span>matrice_refinement()
<span style="color:#75715e">!
</span><span style="color:#75715e"></span><span style="color:#75715e">!**************************************************************************
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">USE </span>decomp_2d
<span style="color:#66d9ef">USE </span>variables
<span style="color:#66d9ef">USE </span>param
<span style="color:#66d9ef">USE </span>var
<span style="color:#66d9ef">USE </span>MPI
<span style="color:#66d9ef">USE </span>derivX
<span style="color:#66d9ef">USE </span>derivY
<span style="color:#66d9ef">USE </span>derivZ

<span style="color:#66d9ef">implicit </span><span style="color:#66d9ef">none
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef"></span><span style="color:#66d9ef">integer</span> <span style="color:#66d9ef">::</span> i,j,k

<span style="color:#66d9ef">complex</span>(mytype),<span style="color:#66d9ef">dimension</span>(sp%yst(<span style="color:#ae81ff">1</span>):sp%yen(<span style="color:#ae81ff">1</span>)) <span style="color:#66d9ef">::</span> transx
<span style="color:#66d9ef">complex</span>(mytype),<span style="color:#66d9ef">dimension</span>(sp%yst(<span style="color:#ae81ff">2</span>):sp%yen(<span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">::</span> transy
<span style="color:#66d9ef">complex</span>(mytype),<span style="color:#66d9ef">dimension</span>(sp%yst(<span style="color:#ae81ff">3</span>):sp%yen(<span style="color:#ae81ff">3</span>)) <span style="color:#66d9ef">::</span> transz
<span style="color:#66d9ef">real</span>(mytype) <span style="color:#66d9ef">::</span> xa0,xa1
<span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> ytt,xtt,ztt,yt1,xt1,yt2,xt2
<span style="color:#66d9ef">complex</span>(mytype) <span style="color:#66d9ef">::</span> xtt1,ytt1,ztt1,zt1,zt2,tmp1,tmp2,tmp3

<span style="color:#66d9ef">do </span>i <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
   xtt<span style="color:#f92672">=</span>cmplx((bicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        cicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (bicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        cicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   xtt1<span style="color:#f92672">=</span>cmplx((aicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (aicix6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   xt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaix6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx)),&amp;
        (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaix6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(exs(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dx)), kind<span style="color:#f92672">=</span>mytype)
   transx(i)<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(xtt1<span style="color:#f92672">+</span>xtt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(xt1, kind<span style="color:#f92672">=</span>mytype),&amp;
        <span style="color:#66d9ef">real</span>(xtt1<span style="color:#f92672">+</span>xtt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(xt1, kind<span style="color:#f92672">=</span>mytype), kind<span style="color:#f92672">=</span>mytype)<span style="color:#75715e">!(xtt+xtt)/xt1
</span><span style="color:#75715e"></span>enddo
<span style="color:#66d9ef">do </span>j <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">2</span>),sp%yen(<span style="color:#ae81ff">2</span>)
   ytt<span style="color:#f92672">=</span>cmplx((biciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        ciciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (biciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
        ciciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   ytt1<span style="color:#f92672">=</span>cmplx((aiciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
        (aiciy6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
   yt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiy6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy)),&amp;
        (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiy6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(eys(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dy)), kind<span style="color:#f92672">=</span>mytype)
   transy(j)<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(ytt1<span style="color:#f92672">+</span>ytt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(yt1, kind<span style="color:#f92672">=</span>mytype),&amp;
        <span style="color:#66d9ef">real</span>(ytt1<span style="color:#f92672">+</span>ytt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(yt1, kind<span style="color:#f92672">=</span>mytype), kind<span style="color:#f92672">=</span>mytype)<span style="color:#75715e">!(ytt+ytt)/yt1
</span><span style="color:#75715e"></span>enddo
<span style="color:#66d9ef">if</span> (nclz<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">   </span><span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
      ztt<span style="color:#f92672">=</span>cmplx((biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
           ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
           (biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
           ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
      ztt1<span style="color:#f92672">=</span>cmplx((aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
           (aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
      zt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz)),&amp;
           (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz)), kind<span style="color:#f92672">=</span>mytype)
      transz(k)<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(ztt1<span style="color:#f92672">+</span>ztt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(zt1, kind<span style="color:#f92672">=</span>mytype),&amp;
           aimag(ztt1<span style="color:#f92672">+</span>ztt)<span style="color:#f92672">/</span>aimag(zt1), kind<span style="color:#f92672">=</span>mytype)<span style="color:#75715e">!(ztt+ztt)/zt1
</span><span style="color:#75715e"></span>   enddo
<span style="color:#66d9ef">else
</span><span style="color:#66d9ef">   </span><span style="color:#66d9ef">do </span>k <span style="color:#f92672">=</span> sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
      ztt<span style="color:#f92672">=</span>cmplx((biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
           ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
           (biciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(aimag(ezs(k))<span style="color:#f92672">*</span><span style="color:#ae81ff">3.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)<span style="color:#f92672">+</span>&amp;
           ciciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(aimag(ezs(k))<span style="color:#f92672">*</span><span style="color:#ae81ff">5.</span><span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
      ztt1<span style="color:#f92672">=</span>cmplx((aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)),&amp;
           (aiciz6<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cos(aimag(ezs(k))<span style="color:#f92672">*</span>dz<span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span>)), kind<span style="color:#f92672">=</span>mytype)
      zt1<span style="color:#f92672">=</span>cmplx((<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(<span style="color:#66d9ef">real</span>(ezs(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>dz)),&amp;
           (<span style="color:#ae81ff">1.</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>ailcaiz6<span style="color:#f92672">*</span>cos(aimag(ezs(k))<span style="color:#f92672">*</span>dz)), kind<span style="color:#f92672">=</span>mytype)
      transz(k)<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(ztt1<span style="color:#f92672">+</span>ztt, kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">/</span><span style="color:#66d9ef">real</span>(zt1, kind<span style="color:#f92672">=</span>mytype),&amp;
           aimag(ztt1<span style="color:#f92672">+</span>ztt)<span style="color:#f92672">/</span>aimag(zt1), kind<span style="color:#f92672">=</span>mytype)<span style="color:#75715e">!(ztt+ztt)/zt1
</span><span style="color:#75715e"></span>   enddo
endif

<span style="color:#66d9ef">if</span> ((istret<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>).or.(istret<span style="color:#f92672">==</span><span style="color:#ae81ff">2</span>)) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef"> 
</span><span style="color:#66d9ef">   </span>xa0<span style="color:#f92672">=</span>alpha<span style="color:#f92672">/</span>pi<span style="color:#f92672">+</span><span style="color:#ae81ff">1.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">/</span>beta<span style="color:#f92672">/</span>pi
   <span style="color:#66d9ef">if</span> (istret<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) xa1<span style="color:#f92672">=</span><span style="color:#ae81ff">1.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">4.</span><span style="color:#f92672">/</span>beta<span style="color:#f92672">/</span>pi
   <span style="color:#66d9ef">if</span> (istret<span style="color:#f92672">==</span><span style="color:#ae81ff">2</span>) xa1<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">4.</span><span style="color:#f92672">/</span>beta<span style="color:#f92672">/</span>pi
<span style="color:#75715e">!
</span><span style="color:#75715e"></span><span style="color:#75715e">!construction of the pentadiagonal matrice
</span><span style="color:#75715e"></span><span style="color:#75715e">!
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
      cw22(i,j,k)<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(yky(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype),&amp;
           aimag(yky(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transz(k)), kind<span style="color:#f92672">=</span>mytype)
      cw2(i,j,k)<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(yky(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype),&amp;
           aimag(yky(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transz(k)), kind<span style="color:#f92672">=</span>mytype)
   enddo
   enddo
   enddo


   

<span style="color:#75715e">!main diagonal
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
      a(i,j,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)&amp;
           <span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           <span style="color:#f92672">-</span>(aimag(xk2(i))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transz(k))<span style="color:#f92672">*</span>aimag(transz(k)))&amp;
           <span style="color:#f92672">-</span>(aimag(zk2(k))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transx(i)))&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j,k))<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">+</span>aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
      a2(i,j,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw2(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw2(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           <span style="color:#f92672">-</span>(aimag(xk2(i))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j))<span style="color:#f92672">*</span>aimag(transz(k))<span style="color:#f92672">*</span>aimag(transz(k)))&amp;
           <span style="color:#f92672">-</span>(aimag(zk2(k))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transx(i)))&amp;
           <span style="color:#f92672">-</span>aimag(cw2(i,j,k))<span style="color:#f92672">*</span>aimag(cw2(i,j,k))<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,j,k))<span style="color:#f92672">*</span>aimag(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">+</span>aimag(cw2(i,j,k))<span style="color:#f92672">*</span>aimag(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   enddo
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
      a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           <span style="color:#f92672">-</span>(aimag(xk2(i))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transz(k))<span style="color:#f92672">*</span>aimag(transz(k)))&amp;
           <span style="color:#f92672">-</span>(aimag(zk2(k))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transx(i)))&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,<span style="color:#ae81ff">2</span>,k))), kind<span style="color:#f92672">=</span>mytype)
      a(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>), kind<span style="color:#f92672">=</span>mytype)&amp;
           <span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           <span style="color:#f92672">-</span>(aimag(xk2(i))<span style="color:#f92672">*</span>aimag(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>))<span style="color:#f92672">*</span>aimag(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>))<span style="color:#f92672">*</span>aimag(transz(k))<span style="color:#f92672">*</span>aimag(transz(k)))&amp;
           <span style="color:#f92672">-</span>(aimag(zk2(k))<span style="color:#f92672">*</span>aimag(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>))<span style="color:#f92672">*</span>aimag(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transx(i)))&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
      a2(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">2</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>(xa0<span style="color:#f92672">-</span>xa1)<span style="color:#f92672">*</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">-</span>xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           <span style="color:#f92672">-</span>(aimag(xk2(i))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span>))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span>))<span style="color:#f92672">*</span>aimag(transz(k))<span style="color:#f92672">*</span>aimag(transz(k)))&amp;
           <span style="color:#f92672">-</span>(aimag(zk2(k))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span>))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">2</span>))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transx(i)))&amp;
           <span style="color:#f92672">-</span>aimag(cw2(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>(xa0<span style="color:#f92672">-</span>xa1)<span style="color:#f92672">*</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">-</span>xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,<span style="color:#ae81ff">2</span>,k))), kind<span style="color:#f92672">=</span>mytype)
      a2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">*</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           <span style="color:#f92672">-</span>(aimag(xk2(i))<span style="color:#f92672">*</span>aimag(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transz(k))<span style="color:#f92672">*</span>aimag(transz(k)))&amp;
           <span style="color:#f92672">-</span>(aimag(zk2(k))<span style="color:#f92672">*</span>aimag(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transy(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transx(i)))&amp;
           <span style="color:#f92672">-</span>aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">*</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   enddo
   
 

 

<span style="color:#75715e">!sup diag +1
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)   
      a(i,j,k,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span>cmplx(xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">+</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
      a2(i,j,k,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span>cmplx(xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,j,k))<span style="color:#f92672">*</span>aimag(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">+</span>aimag(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   enddo
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)   
      a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>cmplx((xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype))),&amp;
           (xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,<span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">+</span>aimag(cw22(i,<span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,<span style="color:#ae81ff">2</span>,k)))), kind<span style="color:#f92672">=</span>mytype)
      a2(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span>cmplx((xa0<span style="color:#f92672">-</span>xa1)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">+</span>xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           (xa0<span style="color:#f92672">-</span>xa1)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,<span style="color:#ae81ff">2</span>,k)))&amp;
           <span style="color:#f92672">+</span>xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,<span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,<span style="color:#ae81ff">2</span>,k))), kind<span style="color:#f92672">=</span>mytype)
      a2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span>cmplx(xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">+</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k)))&amp;
           <span style="color:#f92672">+</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k))), kind<span style="color:#f92672">=</span>mytype)
      a2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   enddo
   enddo



<span style="color:#75715e">!sup diag +2
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)   
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>
      a(i,j,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1,&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1, kind<span style="color:#f92672">=</span>mytype)
      a2(i,j,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1,&amp;
           <span style="color:#f92672">-</span>aimag(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1, kind<span style="color:#f92672">=</span>mytype)
   enddo
   a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">5</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span>,aimag(a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">5</span>))<span style="color:#f92672">*</span><span style="color:#ae81ff">2.</span>, kind<span style="color:#f92672">=</span>mytype)
   a(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   enddo
   enddo



<span style="color:#75715e">!inf diag -1
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)   
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
      a(i,j,k,<span style="color:#ae81ff">2</span>)<span style="color:#f92672">=</span>cmplx(xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">+</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
      a2(i,j,k,<span style="color:#ae81ff">2</span>)<span style="color:#f92672">=</span>cmplx(xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,j,k))<span style="color:#f92672">*</span>aimag(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">+</span>aimag(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">2</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a2(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">2</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a2(i,<span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">2</span>)<span style="color:#f92672">=</span>cmplx(xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype))&amp;
        <span style="color:#f92672">+</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
        xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,<span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,<span style="color:#ae81ff">1</span>,k)))&amp;
        <span style="color:#f92672">+</span>(xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,<span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   a2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">2</span>)<span style="color:#f92672">=</span>cmplx((xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype))&amp;
        <span style="color:#f92672">+</span>xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
        (xa0<span style="color:#f92672">+</span>xa1)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k)))&amp;
        <span style="color:#f92672">+</span>xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   enddo
<span style="color:#75715e">!inf diag -2
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)  
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
      a(i,j,k,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1,&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1, kind<span style="color:#f92672">=</span>mytype)
      a2(i,j,k,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1,&amp;
           <span style="color:#f92672">-</span>aimag(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw2(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1, kind<span style="color:#f92672">=</span>mytype)
   enddo
   a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a(i,<span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a2(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a2(i,<span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   enddo
   enddo
<span style="color:#75715e">!not to have a singular matrice
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
      <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">==</span><span style="color:#ae81ff">0.</span>).and.(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">         </span>a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#ae81ff">1.</span>,<span style="color:#ae81ff">1.</span>, kind<span style="color:#f92672">=</span>mytype)
         a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
         a(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
      endif
   enddo
   enddo

<span style="color:#66d9ef">else
</span><span style="color:#66d9ef">   </span>xa0<span style="color:#f92672">=</span>alpha<span style="color:#f92672">/</span>pi<span style="color:#f92672">+</span><span style="color:#ae81ff">1.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.</span><span style="color:#f92672">/</span>beta<span style="color:#f92672">/</span>pi
   xa1<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1.</span><span style="color:#f92672">/</span><span style="color:#ae81ff">4.</span><span style="color:#f92672">/</span>beta<span style="color:#f92672">/</span>pi
<span style="color:#75715e">!
</span><span style="color:#75715e"></span><span style="color:#75715e">!construction of the pentadiagonal matrice
</span><span style="color:#75715e"></span><span style="color:#75715e">!   
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nym
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
      cw22(i,j,k)<span style="color:#f92672">=</span>cmplx(<span style="color:#66d9ef">real</span>(yky(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype),&amp;
           aimag(yky(j))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transz(k)), kind<span style="color:#f92672">=</span>mytype)
   enddo
   enddo
   enddo

<span style="color:#75715e">!main diagonal
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,nym<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
      a3(i,j,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(j), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           <span style="color:#f92672">-</span>(aimag(xk2(i))<span style="color:#f92672">*</span>aimag(transy(j))<span style="color:#f92672">*</span>aimag(transy(j))<span style="color:#f92672">*</span>aimag(transz(k))<span style="color:#f92672">*</span>aimag(transz(k)))&amp;
           <span style="color:#f92672">-</span>(aimag(zk2(k))<span style="color:#f92672">*</span>aimag(transy(j))<span style="color:#f92672">*</span>aimag(transy(j))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transx(i)))&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j,k))<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">+</span>aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   enddo
   enddo

   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
      a3(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(<span style="color:#ae81ff">1</span>), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           <span style="color:#f92672">-</span>(aimag(xk2(i))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transz(k))<span style="color:#f92672">*</span>aimag(transz(k)))&amp;
           <span style="color:#f92672">-</span>(aimag(zk2(k))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transy(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transx(i)))&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,<span style="color:#ae81ff">2</span>,k))), kind<span style="color:#f92672">=</span>mytype)
      a3(i,nym,k,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(xk2(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(nym), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(nym), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transz(k), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span>(<span style="color:#66d9ef">real</span>(zk2(k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(nym), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transy(nym), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(transx(i), kind<span style="color:#f92672">=</span>mytype))&amp;
           <span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,nym,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,nym,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,nym,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,nym<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           <span style="color:#f92672">-</span>(aimag(xk2(i))<span style="color:#f92672">*</span>aimag(transy(nym))<span style="color:#f92672">*</span>aimag(transy(nym))<span style="color:#f92672">*</span>aimag(transz(k))<span style="color:#f92672">*</span>aimag(transz(k)))&amp;
           <span style="color:#f92672">-</span>(aimag(zk2(k))<span style="color:#f92672">*</span>aimag(transy(nym))<span style="color:#f92672">*</span>aimag(transy(nym))<span style="color:#f92672">*</span>aimag(transx(i))<span style="color:#f92672">*</span>aimag(transx(i)))&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,nym,k))<span style="color:#f92672">*</span>aimag(cw22(i,nym,k))<span style="color:#f92672">*</span>xa0<span style="color:#f92672">*</span>xa0<span style="color:#f92672">-</span>&amp;
           xa1<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,nym,k))<span style="color:#f92672">*</span>aimag(cw22(i,nym<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   enddo

   


<span style="color:#75715e">!sup diag +1
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,nym<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
      a3(i,j,k,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span>cmplx(xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">+</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   a3(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span>cmplx((xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
        <span style="color:#66d9ef">real</span>(cw22(i,<span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype))),&amp;
        (xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,<span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,<span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">+</span>aimag(cw22(i,<span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,<span style="color:#ae81ff">2</span>,k)))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   enddo
<span style="color:#75715e">!sup diag +2
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,nym<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>
      a3(i,j,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1,&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1, kind<span style="color:#f92672">=</span>mytype)
   enddo
   <span style="color:#75715e">!a3(i,1,k,5)=a3(i,1,k,5)*2.
</span><span style="color:#75715e"></span>   <span style="color:#75715e">!a3(i,1,k,5)=0.
</span><span style="color:#75715e"></span>   a3(i,nym<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a3(i,nym,k,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   enddo
   enddo


<span style="color:#75715e">!inf diag -1
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,nym
      a3(i,j,k,<span style="color:#ae81ff">2</span>)<span style="color:#f92672">=</span>cmplx(xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(<span style="color:#66d9ef">real</span>(cw22(i,j,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">+</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>&amp;
           <span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)),&amp;
           xa0<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>(aimag(cw22(i,j,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">+</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))), kind<span style="color:#f92672">=</span>mytype)
   enddo
   a3(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">2</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   enddo
   enddo
<span style="color:#75715e">!inf diag -2
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">do </span>k<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">3</span>),sp%yen(<span style="color:#ae81ff">3</span>)
   <span style="color:#66d9ef">do </span>i<span style="color:#f92672">=</span>sp%yst(<span style="color:#ae81ff">1</span>),sp%yen(<span style="color:#ae81ff">1</span>)
   <span style="color:#66d9ef">do </span>j<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,nym
      a3(i,j,k,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#f92672">-</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span><span style="color:#66d9ef">real</span>(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>,k), kind<span style="color:#f92672">=</span>mytype)<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1,&amp;
           <span style="color:#f92672">-</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,k))<span style="color:#f92672">*</span>aimag(cw22(i,j<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>,k))<span style="color:#f92672">*</span>xa1<span style="color:#f92672">*</span>xa1, kind<span style="color:#f92672">=</span>mytype)
   enddo
   a3(i,<span style="color:#ae81ff">1</span>,k,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a3(i,<span style="color:#ae81ff">2</span>,k,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   enddo
   enddo

<span style="color:#75715e">!not to have a singular matrice
</span><span style="color:#75715e"></span><span style="color:#75715e">!   do k=sp%yst(3),sp%yen(3)
</span><span style="color:#75715e"></span><span style="color:#75715e">!   do i=sp%yst(1),sp%yen(1)
</span><span style="color:#75715e"></span><span style="color:#75715e">!      if ((xkx(i)==0.).and.(zkz(k)==0)) then
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (nrank<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then
</span><span style="color:#66d9ef">   </span>a3(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span>cmplx(<span style="color:#ae81ff">1.</span>,<span style="color:#ae81ff">1.</span>, kind<span style="color:#f92672">=</span>mytype)
   a3(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">4</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
   a3(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>
endif
<span style="color:#75715e">!      endif
</span><span style="color:#75715e"></span><span style="color:#75715e">!   enddo
</span><span style="color:#75715e"></span><span style="color:#75715e">!   enddo
</span><span style="color:#75715e"></span>endif


   


<span style="color:#66d9ef">return
</span><span style="color:#66d9ef"></span><span style="color:#66d9ef">end </span><span style="color:#66d9ef">subroutine </span>matrice_refinement

<span style="color:#66d9ef">end </span><span style="color:#66d9ef">module </span>decomp_2d_poisson
</code></pre></div>
    </div>
 <div class="nav-links" style="padding:10;">
        
        <div align="left">
        <a href="https://jueqingsizhe66.github.io/blog/2014/05/13/md-learning/"><span class="arrow">←</span> <strong>上一篇:markdown_learning</strong></a>
        </div>
        
        


       <div align="right"> <a href="https://jueqingsizhe66.github.io/blog/2014/05/14/xie-bo-ke-de-yi-yi/" ><strong>下一篇:写博客的意义 </strong><span class="arrow">→</span></a></div>
        
      </div>
    





<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/incompact3d/">incompact3d</a>
  
  <a class="badge badge-light" href="/tags/dns/">DNS</a>
  
  <a class="badge badge-light" href="/tags/fortran/">fortran</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://jueqingsizhe66.github.io/blog/2014/05/14/poisson/&amp;text=poisson" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://jueqingsizhe66.github.io/blog/2014/05/14/poisson/&amp;t=poisson" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=poisson&amp;body=https://jueqingsizhe66.github.io/blog/2014/05/14/poisson/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://jueqingsizhe66.github.io/blog/2014/05/14/poisson/&amp;title=poisson" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=poisson%20https://jueqingsizhe66.github.io/blog/2014/05/14/poisson/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://jueqingsizhe66.github.io/blog/2014/05/14/poisson/&amp;title=poisson" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>












  






  
  
  
    
  
  
  <div class="media author-card content-widget-hr">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hub2bcfcfc92fc067668c68513c0d68b69_23221_250x250_fill_q90_lanczos_center.jpg" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://jueqingsizhe66.github.io/">Ye Zhaoliang</a></h5>
      <h6 class="card-subtitle">Engineer of offshore wind turbine technique research</h6>
      <p class="card-text">My research interests include distributed energy, wind turbine power generation technique , Computational fluid dynamic and programmable matter.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/jueqingsizhe66" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.co.uk/citations?user=7VyEMyQAAAAJ&amp;hl=zh-CN" target="_blank" rel="noopener">
        <i class="ai ai-google-scholar"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/jueqingsizhe66" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>









  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/blog/2014/05/13/md-learning/">markdown_learning</a></li>
      
      <li><a href="/blog/2014/03/06/funny-jokes/">funny jokes</a></li>
      
    </ul>


         <span id="busuanzi_container_site_pv"> 
             本站访问量：<span id="busuanzi_value_site_pv"></span>次 
         </span> 
         &nbsp; 
   </div> 


  </div>

</article>
<script src="https://utteranc.es/client.js"
        repo="jueqingsizhe66/jueqingsizhe66.github.io"
        issue-term="pathname"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script>

      

    
    
    
    <script src="/js/mathjax-config.js"></script>
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/go.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/vim.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/matlab.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/sql.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/c.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/scheme.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/racket.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/perl.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/awk.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/clojure.min.js"></script>
        
      

      
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML-full" integrity="sha256-GhM+5JHb6QUzOQPXSJLEWP7R73CbkisjzK5Eyij4U9w=" crossorigin="anonymous" async></script>
      
    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin="anonymous"></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.d6bd04fdad2ad213aa8111c5a3b72fc5.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    ©2020 &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
